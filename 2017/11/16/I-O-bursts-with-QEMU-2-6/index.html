<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>I/O bursts with QEMU 2.6 | Yiran</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="I/O bursts with QEMU 2.6 近期在工作中要进行存储系统的 QOS 验证.公司 QOS 的实现方式参考了  QEMU 中的实现方式, 找来相关资料学习一下. QEMU 2.6 was released a few days ago. One new feature that I have been working on is the new way to configure I">
<meta name="keywords" content="qemu">
<meta property="og:type" content="article">
<meta property="og:title" content="I&#x2F;O bursts with QEMU 2.6">
<meta property="og:url" content="http://zdyxry.com/2017/11/16/I-O-bursts-with-QEMU-2-6/index.html">
<meta property="og:site_name" content="Yiran">
<meta property="og:description" content="I/O bursts with QEMU 2.6 近期在工作中要进行存储系统的 QOS 验证.公司 QOS 的实现方式参考了  QEMU 中的实现方式, 找来相关资料学习一下. QEMU 2.6 was released a few days ago. One new feature that I have been working on is the new way to configure I">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2017-11-16T14:36:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="I&#x2F;O bursts with QEMU 2.6">
<meta name="twitter:description" content="I/O bursts with QEMU 2.6 近期在工作中要进行存储系统的 QOS 验证.公司 QOS 的实现方式参考了  QEMU 中的实现方式, 找来相关资料学习一下. QEMU 2.6 was released a few days ago. One new feature that I have been working on is the new way to configure I">
  
    <link rel="alternate" href="/atom.xml" title="Yiran" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Yiran</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://zdyxry.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-I-O-bursts-with-QEMU-2-6" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/16/I-O-bursts-with-QEMU-2-6/" class="article-date">
  <time datetime="2017-11-16T14:34:48.000Z" itemprop="datePublished">2017-11-16</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      I/O bursts with QEMU 2.6
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>I/O bursts with QEMU 2.6</p>
<p>近期在工作中要进行存储系统的 QOS 验证.公司 QOS 的实现方式参考了  QEMU 中的实现方式, 找来相关资料学习一下.</p>
<p>QEMU 2.6 was released a few days ago. One new feature that I have been working on is the new way to configure I/O limits in disk drives to allow bursts and increase the responsiveness of the virtual machine. In this post I’ll try to explain how it works.</p>
<p>QEMU 2.6 版本已经发布一阵了. 我一直研究的一个新功能是配置虚拟磁盘驱动中的 I/O 限制用来允许突发 I/O 同时提升虚拟机的相应速度. 我将尝试这项功能如何工作的.</p>
<p>The basic settings</p>
<p>基本配置</p>
<p>First I will summarize the basic settings that were already available in earlier versions of QEMU.</p>
<p>首先,我将总结 QEMU 早期版本中已有的基本配置.</p>
<p>Two aspects of the disk I/O can be limited: the number of bytes per second and the number of operations per second (IOPS). For each one of them the user can set a global limit or separate limits for read and write operations. This gives us a total of six different parameters.</p>
<p>磁盘 I/O 有两处可以被限制的方式:  每秒钟字节数(bps) 和 每秒钟操作数( IOPS) . 对于它们中的每一种限制,用户既可以进行全局配置,也可以针对读写进行单独限制. 下面列举了总共 6 个不同的参数.</p>
<p>I/O limits can be set using the throttling.* parameters of -drive, or using the QMP block_set_io_throttle command. These are the names of the parameters for both cases:</p>
<p>I/O 限制可以使用 -dirve 参数中的 throttling ,或者使用 QMP 中的 blocks_set_io_throttle 命令. 下面是两种情况下的参数列举:  </p>
<p>  -DRIVE                   BLOCK_SET_IO_THROTTLE<br>  throttling.iops-total    iops<br>  throttling.iops-read     iops_rd<br>  throttling.iops-write    iops_wr<br>  throttling.bps-total     bps<br>  throttling.bps-read      bps_rd<br>  throttling.bps-write     bps_wr               </p>
<p>It is possible to set limits for both IOPS and bps at the same time, and for each case we can decide whether to have separate read and write limits or not, but if iops-total is set then neither iops-read nor iops-write can be set. The same applies to bps-total and bps-read/write.</p>
<p>可以同时配置 IOPS 和 bps ,针对不同的场景我们可以选择是否配置读写限制,但是如果设置了 iops-total 参数, 那么不能配置 iops-read 和 iops-write. 这个规则同样适用于 bps-total 和 bps-read/write.      </p>
<p>The default value of these parameters is 0, and it means unlimited.</p>
<p>这些参数的默认值都是 0 , 表示没有任何限制. </p>
<p>In its most basic usage, the user can add a drive to QEMU with a limit of, say, 100 IOPS with the following -drive line:</p>
<pre><code>-drive file=hd0.qcow2,throttling.iops-total=100
</code></pre><p>最基本的用法,用户可以为 QEMU 添加一个驱动用于限制 100 IOPS :   </p>
<p>-drive filehd0.qcow2,throttling.iops-total=100  </p>
<p>We can do the same using QMP. In this case all these parameters are mandatory, so we must set to 0 the ones that we don’t want to limit:</p>
<pre><code>{ &quot;execute&quot;: &quot;block_set_io_throttle&quot;,

  &quot;arguments&quot;: {

     &quot;device&quot;: &quot;virtio0&quot;,

     &quot;iops&quot;: 100,

     &quot;iops_rd&quot;: 0,

     &quot;iops_wr&quot;: 0,

     &quot;bps&quot;: 0,

     &quot;bps_rd&quot;: 0,

     &quot;bps_wr&quot;: 0

  }

}
</code></pre><p> 我们可以使用 QMP 达到相同的配置. 在这种情况下,所有的参数都是必须配置的, 所有我们必须给无关参数配置为 0 ,参考配置:   </p>
<pre><code>{ &quot;execute&quot;: &quot;block_set_io_throttle&quot;,

  &quot;arguments&quot;: {

     &quot;device&quot;: &quot;virtio0&quot;,

     &quot;iops&quot;: 100,

     &quot;iops_rd&quot;: 0,

     &quot;iops_wr&quot;: 0,

     &quot;bps&quot;: 0,

     &quot;bps_rd&quot;: 0,

     &quot;bps_wr&quot;: 0

  }

}
</code></pre><p>I/O bursts</p>
<p>突发I/O</p>
<p> While the settings that we have just seen are enough to prevent the virtual machine from performing too much I/O, it can be useful to allow the user to exceed those limits occasionally. This way we can have a more responsive VM that is able to cope better with peaks of activity while keeping the average limits lower the rest of the time.</p>
<p>在刚刚的基本配置中, 我们已经能够预防虚拟机抢占过多 I/O 资源, 偶尔允许用户超出参数限制范围可能会更有用. 通过这种方式, 我们能够拥有一个响应更快的虚拟机,用于应对更多的波峰情况,同时保持其他时间的平均限制.</p>
<p>Starting from QEMU 2.6, it is possible to allow the user to do bursts of I/O for a configurable amount of time. A burst is an amount of I/O that can exceed the basic limit, and there are two parameters that control them: their length and the maximum amount of I/O they allow. These two can be configured separately for each one of the six basic parameters described in the previous section, but here we’ll use ‘iops-total’ as an example.</p>
<p>从 QEMU 2.6 开始, 可以允许用户在可配置的时间区间内进行突发 I/O. 突发 I/O 可以超过基本配置, 有两个参数可以限制他们: 突发 I/O 长度和最大允许 I/O 数量. 这两个参数可以作用于上述基本配置中的每一个参数, 这里使用 iops-total  进行举例.    </p>
<p>The I/O limit during bursts is set using ‘iops-total-max’, and the maximum length (in seconds) is set with ‘iops-total-max-length’. So if we want to configure a drive with a basic limit of 100 IOPS and allow bursts of 2000 IOPS for 60 seconds, we would do it like this (the line is split for clarity):</p>
<pre><code>-drive file=hd0.qcow2,

       throttling.iops-total=100,

       throttling.iops-total-max=2000,

       throttling.iops-total-max-length=60
</code></pre><p>突发 I/O 限制使用 iops-total-max 进行配置, 最大长度(单位: s) 通过 iops-total-max-length 进行配置. 如果我们想要配置一个驱动器基本配置 IOPS 为 100, 同时允许在 60s 时间区间内发生突发 I/O IOPS 为2000. 可以使用如下配置:   </p>
<pre><code>-drive file=hd0.qcow2,


       throttling.iops-total=100,


       throttling.iops-total-max=2000,


       throttling.iops-total-max-length=60
</code></pre><p>Or with QMP:</p>
<pre><code>{ &quot;execute&quot;: &quot;block_set_io_throttle&quot;,


  &quot;arguments&quot;: {


     &quot;device&quot;: &quot;virtio0&quot;,


     &quot;iops&quot;: 100,


     &quot;iops_rd&quot;: 0,


     &quot;iops_wr&quot;: 0,


     &quot;bps&quot;: 0,


     &quot;bps_rd&quot;: 0,


     &quot;bps_wr&quot;: 0,


     &quot;iops_max&quot;: 2000,


     &quot;iops_max_length&quot;: 60,


  }


}
</code></pre><p>或者通过 QMP 进行配置:   </p>
<pre><code>{&quot;execute&quot;:&quot;block_set_io_throttle&quot;,


 &quot;arguments&quot;:{


   &quot;device&quot;:&quot;virtio0&quot;,


   &quot;iops&quot;:100,


   &quot;iops_rd&quot;:0,


   &quot;iops_wr&quot;:0,


   &quot;bps&quot;:0


   &quot;bps_rd&quot;:0


   &quot;bps_wr&quot;:0


   &quot;iops_max&quot;:2000,


   &quot;iops_max_length&quot;:60,


 }}
</code></pre><p>With this, the user can perform I/O on hd0.qcow2 at a rate of 2000 IOPS for 1 minute before it’s throttled down to 100 IOPS.</p>
<p>The user will be able to do bursts again if there’s a sufficiently long period of time with unused I/O (see below for details).</p>
<p>The default value for ‘iops-total-max’ is 0 and it means that bursts are not allowed. ‘iops-total-max-length’ can only be set if ‘iops-total-max’ is set as well, and its default value is 1 second.</p>
<p>通过这种方式, 用户可以控制 hd0.qcow2 以 2000 IOPS 持续 1分钟运行, 然后被限制在基本配置的 100 IOPS 状态.</p>
<p>如果有有足够的时间没有使用 I/O, 用户可以再次进行突发 I/O.   </p>
<p>iops-total-max 默认值为 0 ,表示不允许突发 I/O.  iops-total-max-length 只能在配置 iops-total-max的前提下进行配置, 默认值为 1秒.</p>
<p>Controlling the size of I/O operations</p>
<p>控制 I/O 块大小</p>
<p>When applying IOPS limits all I/O operations are treated equally regardless of their size. This means that the user can take advantage of this in order to circumvent the limits and submit one huge I/O request instead of several smaller ones.</p>
<p>当配置 IOPS 限制时, 所有的 I/O 操作都会被平等对待,不论 I/O 块大小. 这意味着用户可以利用这点来规避 I/O 限制,将一些小 I/O 替换为一个大块 I/O.</p>
<p>QEMU provides a setting called throttling.iops-size to prevent this from happening. This setting specifies the size (in bytes) of an I/O request for accounting purposes. Larger requests will be counted proportionally to this size.</p>
<p>QEMU 提供了 throttling.iops-size  配置用来防止这种情况发生. 这个设置指定请求的每个 I/O 大小.过大的请求将会进行相应的统计. </p>
<p>For example, if iops-size is set to 4096 then an 8KB request will be counted as two, and a 6KB request will be counted as one and a half. This only applies to requests larger than iops-size: smaller requests will be always counted as one, no matter their size.</p>
<p>比如, 如果 iops-size 设置为 4096, 那么 8KB 的 I/O 请求将会被记为 2 ,6KB 请求记为1.5. 该配置只作用于大于 iops-size 配置的 I/O 请求, 如果 I/O 请求小于该数值,则不论大小均记为 1. </p>
<p>The default value of iops-size is 0 and it means that the size of the requests is never taken into account when applying IOPS limits.</p>
<p>iops-size默认值为 0 ,表示这个默认的 IOPS 限制不考虑每次 I/O 请求的块大小. </p>
<p>Applying I/O limits to groups of disks</p>
<p>I/O 限制在磁盘组的应用</p>
<p>In all the examples so far we have seen how to apply limits to the I/O performed on individual drives, but QEMU allows grouping drives so they all share the same limits.</p>
<p>This feature is available since QEMU 2.4. Please refer to the post I wrote when it was published for more details.</p>
<p>在刚刚的例子中我们已经看到如何去限制 I/O 在各个驱动器上, 但是 QEMU 同时允许将驱动器进行分组, 这样驱动器组具有相同的 I/O 限制. </p>
<p>这个功能在 QEMU 2.4 版本已经生效, 更多信息可以参考其他文档. </p>
<p>The Leaky Bucket algorithm</p>
<p>Leaky Bucket 算法</p>
<p>I/O limits in QEMU are implemented using the leaky bucket algorithm (specifically the “Leaky bucket as a meter” variant).</p>
<p>This algorithm uses the analogy of a bucket that leaks water constantly. The water that gets into the bucket represents the I/O that has been performed, and no more I/O is allowed once the bucket is full.</p>
<p>QEMU 中的 I/O 限制使用 Leaky Bucket 算法实现.</p>
<p>该算法使用不断漏水的桶进行类比. 入水口比作在进行的 I/O, 当桶处于满状态时, 不再允许 I/O 下发. </p>
<p>To see the way this corresponds to the throttling parameters in QEMU, consider the following values:</p>
<pre><code>iops-total=100


iops-total-max=2000


iops-total-max-length=60
</code></pre><ul>
<li>Water leaks from the bucket at a rate of 100 IOPS.</li>
<li>Water can be added to the bucket at a rate of 2000 IOPS.</li>
<li>The size of the bucket is 2000 x 60 = 120000.</li>
<li>If iops-total-max is unset then the bucket size is 100.</li>
</ul>
<p>想要查看 QEMU 中的 I/O 限制对应方式,可以参考如下数值:   </p>
<pre><code>iops-total=100


iops-total-max=2000


iops-total-max-length=60
</code></pre><ul>
<li>水以 100 IOPS 的速度从桶中漏出</li>
<li>水可以以 2000 IOPS 的速度添加到桶中</li>
<li>桶的大小为 2000 * 60 = 120000</li>
<li>如果 iops-total-max 没有配置, 那么桶的大小是 100</li>
</ul>
<p>The bucket is initially empty, therefore water can be added until it’s full at a rate of 2000 IOPS (the burst rate). Once the bucket is full we can only add as much water as it leaks, therefore the I/O rate is reduced to 100 IOPS. If we add less water than it leaks then the bucket will start to empty, allowing for bursts again.</p>
<p>Note that since water is leaking from the bucket even during bursts, it will take a bit more than 60 seconds at 2000 IOPS to fill it up. After those 60 seconds the bucket will have leaked 60 x 100 = 6000, allowing for 3 more seconds of I/O at 2000 IOPS.</p>
<p>Also, due to the way the algorithm works, longer burst can be done at a lower I/O rate, e.g. 1000 IOPS during 120 seconds.</p>
<p>最初, 桶状态为空, 可以向桶中添加水直到 2000 IOPS 速率满为止. 当桶满了后, 我们只能添加更可能多的水,因为桶在加水的同时也在漏水. 此时 I/O 速率下降至 100 IOPS. 如果我们添加的水少于泄露的水,那么我们可以再次进行突发 I/O.  </p>
<p>注意, 在突发 I/O 期间,水从桶中泄露, 也需要超过 60s 的时间以 2000 IOPS 的速率填满. 当 60s 过后, 桶将泄露 100*60=6000 的水, 能够允许突发 I/O 再运行 3s.</p>
<p>而且, 由于算法的工作方式, 长时间的突发 I/O 也可以通过较低的 I/O 速率完成,比如 120s 内以 1000 IOPS 完成.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://zdyxry.com/2017/11/16/I-O-bursts-with-QEMU-2-6/" data-id="cja2kxybb0000kw79fj7nsn1k" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/qemu/">qemu</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2017/10/26/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/qemu/">qemu</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/qemu/" style="font-size: 10px;">qemu</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2017/11/16/I-O-bursts-with-QEMU-2-6/">I/O bursts with QEMU 2.6</a>
          </li>
        
          <li>
            <a href="/2017/10/26/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2017 yiran<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>