<!doctype html><html lang=en><head><title>CentOS 多网卡多网关配置 · Yiran's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yiran Zhou"><meta name=description content="背景 Link to heading 日常使用中，开发机通常只配置一块网卡，通常配置为 DHCP 自动获取 IP，这样就可以自动从 DHCP Server 获取 IP，网关，DNS Server 等配置，不用手动配置。
最近在工作中存在一种场景，一台服务器，多块网卡，需要对不同的网卡配置各自网关，查找了一些资料，也踩了一些坑，记录一下过程。
配置过程 Link to heading 官方配置 尝试在 /etc/sysconfig/network-scripts/ifcfg-<device> 中增加 GATEWAY 自动使之生效，实际上来看，多张网卡都配置 GATEWAY 字段会产生冲突，只能放弃通过网卡配置文件方式，尝试通过给网卡配置静态路由方式添加。
在 CentOS 官方网站查找配置静态路由方法，文档中提到通过编写网卡路由配置文件/etc/sysconfig/network-scripts/route-_<interface> ，配置完成后重启网络可以自动生效。
官方这种方式我尝试了两种文件编写方式，一种为192.168.64.0/20 via <gateway> dev <device>，一种为 ADDRESS0=xxxxx; NETMASK0=xxxxx; GATEWAY0=xxxxx。两种配置方式均没有生效，只能放弃。
手动配置 可以通过 route add 命令临时给第二章网卡配置网关，通过 route -n 查看是可以生效。但是因为最终目标是让路由随着网络服务（公司内部未使用 NetworkManager）Network 启动而配置，因此在 /etc/rc.local 中假如 route add 类似命令无法走通。
上述方法要么无法生效，要么存在无法持久化问题，均无法完成需求。 只能通过查看 网卡服务启动脚本来查找，查看 /etc/init.d/network （systemd 服务控制也是执行该文件），该文件是一个 Shell 脚本，找到路由配置相关：
2 # Add non interface-specific static-routes. 1 if [ -f /etc/sysconfig/static-routes ]; then 141 if [ -x /sbin/route ]; then 1 grep &#34;^any&#34; /etc/sysconfig/static-routes | while read ignore args ; do 2 /sbin/route add -$args 3 done 4 else 5 net_log $&#34;Legacy static-route support not available: /sbin/route not found&#34; 6 fi 7 fi 可以看到，在网络服务 network 启动过程中，会判断 /etc/sysconfig/static-routes 文件是否存在，如果存在则会通过 route 命令对该文件中记录以 any 开头的路由进行添加，添加命令为 /sbin/route add -$args。"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="CentOS 多网卡多网关配置"><meta name=twitter:description content="背景 Link to heading 日常使用中，开发机通常只配置一块网卡，通常配置为 DHCP 自动获取 IP，这样就可以自动从 DHCP Server 获取 IP，网关，DNS Server 等配置，不用手动配置。
最近在工作中存在一种场景，一台服务器，多块网卡，需要对不同的网卡配置各自网关，查找了一些资料，也踩了一些坑，记录一下过程。
配置过程 Link to heading 官方配置 尝试在 /etc/sysconfig/network-scripts/ifcfg-<device> 中增加 GATEWAY 自动使之生效，实际上来看，多张网卡都配置 GATEWAY 字段会产生冲突，只能放弃通过网卡配置文件方式，尝试通过给网卡配置静态路由方式添加。
在 CentOS 官方网站查找配置静态路由方法，文档中提到通过编写网卡路由配置文件/etc/sysconfig/network-scripts/route-_<interface> ，配置完成后重启网络可以自动生效。
官方这种方式我尝试了两种文件编写方式，一种为192.168.64.0/20 via <gateway> dev <device>，一种为 ADDRESS0=xxxxx; NETMASK0=xxxxx; GATEWAY0=xxxxx。两种配置方式均没有生效，只能放弃。
手动配置 可以通过 route add 命令临时给第二章网卡配置网关，通过 route -n 查看是可以生效。但是因为最终目标是让路由随着网络服务（公司内部未使用 NetworkManager）Network 启动而配置，因此在 /etc/rc.local 中假如 route add 类似命令无法走通。
上述方法要么无法生效，要么存在无法持久化问题，均无法完成需求。 只能通过查看 网卡服务启动脚本来查找，查看 /etc/init.d/network （systemd 服务控制也是执行该文件），该文件是一个 Shell 脚本，找到路由配置相关：
2 # Add non interface-specific static-routes. 1 if [ -f /etc/sysconfig/static-routes ]; then 141 if [ -x /sbin/route ]; then 1 grep &#34;^any&#34; /etc/sysconfig/static-routes | while read ignore args ; do 2 /sbin/route add -$args 3 done 4 else 5 net_log $&#34;Legacy static-route support not available: /sbin/route not found&#34; 6 fi 7 fi 可以看到，在网络服务 network 启动过程中，会判断 /etc/sysconfig/static-routes 文件是否存在，如果存在则会通过 route 命令对该文件中记录以 any 开头的路由进行添加，添加命令为 /sbin/route add -$args。"><meta property="og:title" content="CentOS 多网卡多网关配置"><meta property="og:description" content="背景 Link to heading 日常使用中，开发机通常只配置一块网卡，通常配置为 DHCP 自动获取 IP，这样就可以自动从 DHCP Server 获取 IP，网关，DNS Server 等配置，不用手动配置。
最近在工作中存在一种场景，一台服务器，多块网卡，需要对不同的网卡配置各自网关，查找了一些资料，也踩了一些坑，记录一下过程。
配置过程 Link to heading 官方配置 尝试在 /etc/sysconfig/network-scripts/ifcfg-<device> 中增加 GATEWAY 自动使之生效，实际上来看，多张网卡都配置 GATEWAY 字段会产生冲突，只能放弃通过网卡配置文件方式，尝试通过给网卡配置静态路由方式添加。
在 CentOS 官方网站查找配置静态路由方法，文档中提到通过编写网卡路由配置文件/etc/sysconfig/network-scripts/route-_<interface> ，配置完成后重启网络可以自动生效。
官方这种方式我尝试了两种文件编写方式，一种为192.168.64.0/20 via <gateway> dev <device>，一种为 ADDRESS0=xxxxx; NETMASK0=xxxxx; GATEWAY0=xxxxx。两种配置方式均没有生效，只能放弃。
手动配置 可以通过 route add 命令临时给第二章网卡配置网关，通过 route -n 查看是可以生效。但是因为最终目标是让路由随着网络服务（公司内部未使用 NetworkManager）Network 启动而配置，因此在 /etc/rc.local 中假如 route add 类似命令无法走通。
上述方法要么无法生效，要么存在无法持久化问题，均无法完成需求。 只能通过查看 网卡服务启动脚本来查找，查看 /etc/init.d/network （systemd 服务控制也是执行该文件），该文件是一个 Shell 脚本，找到路由配置相关：
2 # Add non interface-specific static-routes. 1 if [ -f /etc/sysconfig/static-routes ]; then 141 if [ -x /sbin/route ]; then 1 grep &#34;^any&#34; /etc/sysconfig/static-routes | while read ignore args ; do 2 /sbin/route add -$args 3 done 4 else 5 net_log $&#34;Legacy static-route support not available: /sbin/route not found&#34; 6 fi 7 fi 可以看到，在网络服务 network 启动过程中，会判断 /etc/sysconfig/static-routes 文件是否存在，如果存在则会通过 route 命令对该文件中记录以 any 开头的路由进行添加，添加命令为 /sbin/route add -$args。"><meta property="og:type" content="article"><meta property="og:url" content="https://zdyxry.github.io/2018/05/29/CentOS-%E5%A4%9A%E7%BD%91%E5%8D%A1%E5%A4%9A%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-05-29T19:21:36+00:00"><meta property="article:modified_time" content="2018-05-29T19:21:36+00:00"><link rel=canonical href=https://zdyxry.github.io/2018/05/29/CentOS-%E5%A4%9A%E7%BD%91%E5%8D%A1%E5%A4%9A%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.01bd429dda63a16d76996eaf0b8da061429b76e714515cb1b246aac7fe7f4b2a.css integrity="sha256-Ab1CndpjoW12mW6vC42gYUKbducUUVyxskaqx/5/Syo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/yiran.png sizes=32x32><link rel=icon type=image/png href=/images/yiran.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.101.0"></head><body class="preload-transitions colorscheme-dark"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Yiran's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://zdyxry.github.io/2018/05/29/CentOS-%E5%A4%9A%E7%BD%91%E5%8D%A1%E5%A4%9A%E7%BD%91%E5%85%B3%E9%85%8D%E7%BD%AE/>CentOS 多网卡多网关配置</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2018-05-29T19:21:36Z>May 29, 2018</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
2-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/Linux/>Linux</a></span></div></div></header><nav id=TableOfContents><ul><li><ul><li><a href=#背景>背景</a></li><li><a href=#配置过程>配置过程</a></li><li><a href=#问题排查>问题排查</a></li><li><a href=#总结>总结</a></li></ul></li></ul></nav><div class=post-content><h3 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>日常使用中，开发机通常只配置一块网卡，通常配置为 DHCP 自动获取 IP，这样就可以自动从 DHCP Server 获取 IP，网关，DNS Server 等配置，不用手动配置。</p><p>最近在工作中存在一种场景，一台服务器，多块网卡，需要对不同的网卡配置各自网关，查找了一些资料，也踩了一些坑，记录一下过程。</p><h3 id=配置过程>配置过程
<a class=heading-link href=#%e9%85%8d%e7%bd%ae%e8%bf%87%e7%a8%8b><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><ol><li><p>官方配置
尝试在 <code>/etc/sysconfig/network-scripts/ifcfg-&lt;device></code> 中增加 GATEWAY 自动使之生效，实际上来看，多张网卡都配置 GATEWAY 字段会产生冲突，只能放弃通过网卡配置文件方式，尝试通过给网卡配置静态路由方式添加。<br>在 CentOS <a href=https://www.centos.org/docs/5/html/5.2/Deployment_Guide/s1-networkscripts-static-routes.html>官方网站</a>查找配置静态路由方法，文档中提到通过编写网卡路由配置文件<code>/etc/sysconfig/network-scripts/route-_&lt;interface></code> ，配置完成后重启网络可以自动生效。<br>官方这种方式我尝试了两种文件编写方式，一种为<code>192.168.64.0/20 via &lt;gateway> dev &lt;device></code>，一种为 <code>ADDRESS0=xxxxx; NETMASK0=xxxxx; GATEWAY0=xxxxx</code>。两种配置方式均没有生效，只能放弃。</p></li><li><p>手动配置<br>可以通过 <code>route add</code> 命令临时给第二章网卡配置网关，通过 <code>route -n</code> 查看是可以生效。但是因为最终目标是让路由随着网络服务（公司内部未使用 NetworkManager）Network 启动而配置，因此在 /etc/rc.local 中假如 <code>route add</code> 类似命令无法走通。</p></li><li><p>上述方法要么无法生效，要么存在无法持久化问题，均无法完成需求。 只能通过查看 网卡服务启动脚本来查找，查看 <code>/etc/init.d/network</code> （systemd 服务控制也是执行该文件），该文件是一个 Shell 脚本，找到路由配置相关：</p></li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>    2     <span style=font-style:italic># Add non interface-specific static-routes.</span>
</span></span><span style=display:flex><span>    1     <span style=font-weight:700>if</span> [ -f /etc/sysconfig/static-routes ]; <span style=font-weight:700>then</span>
</span></span><span style=display:flex><span>  141        <span style=font-weight:700>if</span> [ -x /sbin/route ]; <span style=font-weight:700>then</span>
</span></span><span style=display:flex><span>    1            grep <span style=font-style:italic>&#34;^any&#34;</span> /etc/sysconfig/static-routes | <span style=font-weight:700>while</span> read ignore args ; <span style=font-weight:700>do</span>
</span></span><span style=display:flex><span>    2                    /sbin/route add -$args
</span></span><span style=display:flex><span>    3            <span style=font-weight:700>done</span>
</span></span><span style=display:flex><span>    4        <span style=font-weight:700>else</span>
</span></span><span style=display:flex><span>    5            net_log <span style=font-style:italic>$&#34;Legacy static-route support not available: /sbin/route not found&#34;</span>
</span></span><span style=display:flex><span>    6        <span style=font-weight:700>fi</span>
</span></span><span style=display:flex><span>    7     <span style=font-weight:700>fi</span>
</span></span></code></pre></div><p>可以看到，在网络服务 network 启动过程中，会判断 <code>/etc/sysconfig/static-routes</code> 文件是否存在，如果存在则会通过 <code>route</code> 命令对该文件中记录以 <code>any</code> 开头的路由进行添加，添加命令为 <code>/sbin/route add -$args</code>。<br>根据上述脚本，尝试编写 static-routes 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>any net 192.168.64.0/20 gw 192.168.64.1
</span></span><span style=display:flex><span>any net 10.0.10.0/24 gw 10.0.10.222
</span></span></code></pre></div><p>编写完成后，重启网络服务 <code>systemctl restart network</code> ，执行 <code>route -n</code> 查看是否生效：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@scvm9 19:49:55 ~]$route -n
</span></span><span style=display:flex><span>Kernel IP routing table
</span></span><span style=display:flex><span>Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
</span></span><span style=display:flex><span>0.0.0.0         192.168.64.1    0.0.0.0         UG    0      0        0 eth0
</span></span><span style=display:flex><span>10.0.10.0       0.0.0.0         255.255.255.0   U     0      0        0 eth2
</span></span><span style=display:flex><span>10.0.10.0       10.0.10.222     255.255.255.0   UG    0      0        0 eth2
</span></span><span style=display:flex><span>169.254.0.0     0.0.0.0         255.255.0.0     U     1002   0        0 eth0
</span></span></code></pre></div><p>看上去已经生效，因为实际环境中没有第二块网卡网关设备，临时指定一个不存在的 IP。
本以为已经搞定，结果在实际验证的时候，发现第二块网卡无法连接其他节点，哪怕其他节点与它二层联通；尝试将网关指定可以正常工作的 IP 节点，可以与其他节点联通，且 traceroute 也没有经过网关而是直接连接。</p><h3 id=问题排查>问题排查
<a class=heading-link href=#%e9%97%ae%e9%a2%98%e6%8e%92%e6%9f%a5><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><ol><li>尝试将网关配置成可以正常工作的节点<ul><li>各个节点可以正确联通</li><li>traceroute 到其他节点未经过网关</li></ul></li><li>尝试将网关配置成不存在节点<ul><li>各个节点无法正确联通</li></ul></li><li>尝试将网关掩码配置为网卡掩码的超集<ul><li>各个节点可以正确联通</li><li>traceroute 到其他节点未经过网关</li></ul></li></ol><h3 id=总结>总结
<a class=heading-link href=#%e6%80%bb%e7%bb%93><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>红帽系列发行版本配置静态路由可通过 /etc/sysconfig/static-routes 配置生效，但要注意在 static-routes 文件中的路由添加要添加网关节点对应的掩码而不是本地节点网卡掩码，网关掩码为本地网卡掩码的超集。</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//zdyxry.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2023
Yiran Zhou
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0433XDZ3V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G0433XDZ3V",{anonymize_ip:!1})}</script></body></html>