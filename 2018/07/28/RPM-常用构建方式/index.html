<!doctype html><html lang=en><head><title>RPM 常用构建方式 · Yiran's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yiran Zhou"><meta name=description content="背景 Link to heading 作为一个标准化的产品，需要提供简单快捷的软件安装方式，比如 Python pip、 Ubuntu apt-get、SUSE zypper 或者是 CentOS/RHEL yum。都可以让用户快速的安装产品并上手使用，极大的节省了软件安装的时间。因为工作中使用的发行版是 CentOS/RHEL 系列，常用的方式是 RPM。 本文介绍下常用的集中构建 RPM 软件包方式，便于快速上手构建属于自己的 RPM。
RPM 介绍 Link to heading 什么是 RPM？ RPM 全称为 RedHat Package Manager，也就是常见的以 .rpm 为后缀的软件包。属于 RedHat 系列发行版的通用软件包解决方式。 在安装 CentOS(RHEL，以下 CentOS 均可适用于 RHEL)操作系统时，我们可以选择要安装的软件包，默认系统安装为 Minimal 模式，只包含系统必要的 RPM。
理论上操作系统上所有的软件都是通过 RPM 的方式安装的，比如常用的 Kernel、GCC、LS 等工具。
RPM 使用 Link to heading 在进行 RPM 安装时，通常会遇到一个问题：依赖。由于某些特定的软件包在使用时，要求系统必须安装其所依赖的软件才可以正常工作，因此我们需要查看要安装的软件包的依赖。
root@yiran-30-250:~/project/Blog master ✔ $ rpm -qR sos-3.2-35.el7.centos.3.noarch /usr/bin/python bzip2 config(sos) = 3.2-35.el7.centos.3 libxml2-python python(abi) = 2."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="RPM 常用构建方式"><meta name=twitter:description content="背景 Link to heading 作为一个标准化的产品，需要提供简单快捷的软件安装方式，比如 Python pip、 Ubuntu apt-get、SUSE zypper 或者是 CentOS/RHEL yum。都可以让用户快速的安装产品并上手使用，极大的节省了软件安装的时间。因为工作中使用的发行版是 CentOS/RHEL 系列，常用的方式是 RPM。 本文介绍下常用的集中构建 RPM 软件包方式，便于快速上手构建属于自己的 RPM。
RPM 介绍 Link to heading 什么是 RPM？ RPM 全称为 RedHat Package Manager，也就是常见的以 .rpm 为后缀的软件包。属于 RedHat 系列发行版的通用软件包解决方式。 在安装 CentOS(RHEL，以下 CentOS 均可适用于 RHEL)操作系统时，我们可以选择要安装的软件包，默认系统安装为 Minimal 模式，只包含系统必要的 RPM。
理论上操作系统上所有的软件都是通过 RPM 的方式安装的，比如常用的 Kernel、GCC、LS 等工具。
RPM 使用 Link to heading 在进行 RPM 安装时，通常会遇到一个问题：依赖。由于某些特定的软件包在使用时，要求系统必须安装其所依赖的软件才可以正常工作，因此我们需要查看要安装的软件包的依赖。
root@yiran-30-250:~/project/Blog master ✔ $ rpm -qR sos-3.2-35.el7.centos.3.noarch /usr/bin/python bzip2 config(sos) = 3.2-35.el7.centos.3 libxml2-python python(abi) = 2."><meta property="og:title" content="RPM 常用构建方式"><meta property="og:description" content="背景 Link to heading 作为一个标准化的产品，需要提供简单快捷的软件安装方式，比如 Python pip、 Ubuntu apt-get、SUSE zypper 或者是 CentOS/RHEL yum。都可以让用户快速的安装产品并上手使用，极大的节省了软件安装的时间。因为工作中使用的发行版是 CentOS/RHEL 系列，常用的方式是 RPM。 本文介绍下常用的集中构建 RPM 软件包方式，便于快速上手构建属于自己的 RPM。
RPM 介绍 Link to heading 什么是 RPM？ RPM 全称为 RedHat Package Manager，也就是常见的以 .rpm 为后缀的软件包。属于 RedHat 系列发行版的通用软件包解决方式。 在安装 CentOS(RHEL，以下 CentOS 均可适用于 RHEL)操作系统时，我们可以选择要安装的软件包，默认系统安装为 Minimal 模式，只包含系统必要的 RPM。
理论上操作系统上所有的软件都是通过 RPM 的方式安装的，比如常用的 Kernel、GCC、LS 等工具。
RPM 使用 Link to heading 在进行 RPM 安装时，通常会遇到一个问题：依赖。由于某些特定的软件包在使用时，要求系统必须安装其所依赖的软件才可以正常工作，因此我们需要查看要安装的软件包的依赖。
root@yiran-30-250:~/project/Blog master ✔ $ rpm -qR sos-3.2-35.el7.centos.3.noarch /usr/bin/python bzip2 config(sos) = 3.2-35.el7.centos.3 libxml2-python python(abi) = 2."><meta property="og:type" content="article"><meta property="og:url" content="https://zdyxry.github.io/2018/07/28/RPM-%E5%B8%B8%E7%94%A8%E6%9E%84%E5%BB%BA%E6%96%B9%E5%BC%8F/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2018-07-28T06:47:40+00:00"><meta property="article:modified_time" content="2018-07-28T06:47:40+00:00"><link rel=canonical href=https://zdyxry.github.io/2018/07/28/RPM-%E5%B8%B8%E7%94%A8%E6%9E%84%E5%BB%BA%E6%96%B9%E5%BC%8F/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.01bd429dda63a16d76996eaf0b8da061429b76e714515cb1b246aac7fe7f4b2a.css integrity="sha256-Ab1CndpjoW12mW6vC42gYUKbducUUVyxskaqx/5/Syo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/yiran.png sizes=32x32><link rel=icon type=image/png href=/images/yiran.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.101.0"></head><body class="preload-transitions colorscheme-dark"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Yiran's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://zdyxry.github.io/2018/07/28/RPM-%E5%B8%B8%E7%94%A8%E6%9E%84%E5%BB%BA%E6%96%B9%E5%BC%8F/>RPM 常用构建方式</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2018-07-28T06:47:40Z>July 28, 2018</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
4-minute read</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/Linux/>Linux</a></span></div></div></header><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#rpm-介绍>RPM 介绍</a></li><li><a href=#rpm-使用>RPM 使用</a></li><li><a href=#rpm-构建方式>RPM 构建方式</a><ul><li><a href=#rpmbuild>rpmbuild</a></li><li><a href=#fpm>FPM</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#吐槽>吐槽</a></li></ul></nav><div class=post-content><h2 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>作为一个标准化的产品，需要提供简单快捷的软件安装方式，比如 Python pip、 Ubuntu apt-get、SUSE zypper 或者是 CentOS/RHEL yum。都可以让用户快速的安装产品并上手使用，极大的节省了软件安装的时间。因为工作中使用的发行版是 CentOS/RHEL 系列，常用的方式是 RPM。
本文介绍下常用的集中构建 RPM 软件包方式，便于快速上手构建属于自己的 RPM。</p><h2 id=rpm-介绍>RPM 介绍
<a class=heading-link href=#rpm-%e4%bb%8b%e7%bb%8d><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>什么是 RPM？ RPM 全称为 RedHat Package Manager，也就是常见的以 <code>.rpm</code> 为后缀的软件包。属于 RedHat 系列发行版的通用软件包解决方式。
在安装 CentOS(RHEL，以下 CentOS 均可适用于 RHEL)操作系统时，我们可以选择要安装的软件包，默认系统安装为 Minimal 模式，只包含系统必要的 RPM。</p><p>理论上操作系统上所有的软件都是通过 RPM 的方式安装的，比如常用的 Kernel、GCC、LS 等工具。</p><h2 id=rpm-使用>RPM 使用
<a class=heading-link href=#rpm-%e4%bd%bf%e7%94%a8><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>在进行 RPM 安装时，通常会遇到一个问题：依赖。由于某些特定的软件包在使用时，要求系统必须安装其所依赖的软件才可以正常工作，因此我们需要查看要安装的软件包的依赖。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Bash data-lang=Bash><span style=display:flex><span>root@yiran-30-250:~/project/Blog
</span></span><span style=display:flex><span>master ✔ $ rpm -qR sos-3.2-35.el7.centos.3.noarch
</span></span><span style=display:flex><span>/usr/bin/python
</span></span><span style=display:flex><span>bzip2
</span></span><span style=display:flex><span>config(sos) = 3.2-35.el7.centos.3
</span></span><span style=display:flex><span>libxml2-python
</span></span><span style=display:flex><span>python(abi) = 2.7
</span></span><span style=display:flex><span>python-six
</span></span><span style=display:flex><span>rpmlib(CompressedFileNames) &lt;= 3.0.4-1
</span></span><span style=display:flex><span>rpmlib(FileDigests) &lt;= 4.6.0-1
</span></span><span style=display:flex><span>rpmlib(PartialHardlinkSets) &lt;= 4.0.4-1
</span></span><span style=display:flex><span>rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1
</span></span><span style=display:flex><span>xz
</span></span><span style=display:flex><span>rpmlib(PayloadIsXz) &lt;= 5.2-1
</span></span></code></pre></div><p>在安装之前博客提到的 sos 软件时，需要安装 Python、bzip、config 等软件包才可以正常使用 sos。</p><p>此时遇到一个问题，如果 bzip 又依赖某些其他的 RPM，我们如何解决呢，当然可以继续使用 <code>rpm -qR</code> 来查看 bzip 的依赖，然后手动进行安装，但是 Duke University 团队提供了更好用的工具：Yum(Yellow dog Updater, Modified)。可以自动帮助我们解决 RPM 依赖问题。我们只需要在 <code>/etc/yum.repos.d/</code> 路径下配置合理的 yum repo 配置文件，就可以直接使用 <code>yum install sos</code> 的方式安装软件包。在 Fedora 22 版本之后，提供了新的工具叫做 DNF，标称为 Yum 下一代工具（但我没觉得有多好用。。。）。</p><h2 id=rpm-构建方式>RPM 构建方式
<a class=heading-link href=#rpm-%e6%9e%84%e5%bb%ba%e6%96%b9%e5%bc%8f><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>简单介绍了 RPM 的基础使用，具体常用的操作比如：升级、卸载、强制安装、不检查依赖卸载等操作，需要大家自行 Google。</p><p>下面介绍两种方式构建 RPM。</p><h3 id=rpmbuild>rpmbuild
<a class=heading-link href=#rpmbuild><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><p>常规构建 RPM 方式是使用 rpmbuild 工具，我们需要自己编写好相应的 spec 文件，打包压缩好要构建的软件，完成 RPM 构建，下面讲解具体方式。</p><h4 id=安装-rpm-build>安装 rpm-build
<a class=heading-link href=#%e5%ae%89%e8%a3%85-rpm-build><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>使用 yum 命令安装： <code>yum install rpm-build</code> 。会自动将 rpm-build 依赖软件安装，依赖包名如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>elfutils-libelf
</span></span><span style=display:flex><span>rpm
</span></span><span style=display:flex><span>rpm-libs
</span></span><span style=display:flex><span>rpm-python
</span></span></code></pre></div><h4 id=rpm-构建路径>RPM 构建路径
<a class=heading-link href=#rpm-%e6%9e%84%e5%bb%ba%e8%b7%af%e5%be%84><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>在 rpm-build 安装完成后，会自动在 /root/ 下创建相应 rpmbuild 文件夹，会包含构建 RPM 所必须的路径，你也可以之后构建时手动指定路径，但是不推荐新手这种方式，会增加 debug 成本，默认就好。</p><h4 id=准备-tar-软件包>准备 tar 软件包
<a class=heading-link href=#%e5%87%86%e5%a4%87-tar-%e8%bd%af%e4%bb%b6%e5%8c%85><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>在准备工作完成后，我们需要准备软件包源文件，并放置 <code>/root/rpmbuild/SOURCES/</code> 路径下。开源软件包通常可以在晚上下载到，如果是本地 git 管理的仓库，也可以通过以下方式自动生成 Tar 包。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>git archive --format=tar.gz --prefix=$RPM_VERSION HEAD &gt; /root/rpmbuild/SOURCES/
</span></span></code></pre></div><h4 id=创建-spec-文件>创建 SPEC 文件
<a class=heading-link href=#%e5%88%9b%e5%bb%ba-spec-%e6%96%87%e4%bb%b6><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>接下来是最重要的一步，也是出错最多的一步，准备 SPEC 文件。</p><p>SPEC 配置文件指定了在 RPM 构建时进行的操作，和 RPM 安装时执行的操作、拷贝对应源文件到哪个路径、要创建哪些文件夹等。</p><p>我们仍以 sos 作为示例，sos 作为 RedHat 开源软件，在 Github 上是包含了对应的 <a href=https://github.com/sosreport/sos/blob/master/sos.spec>sos.spec</a> 文件的。</p><p>截取重要的部分：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>%{!<span>?</span>python_sitelib: %define python_sitelib %(%{__python} -c <span style=font-style:italic>&#34;from distutils.sysconfig import get_python_lib; print get_python_lib()&#34;</span>)}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Summary: A set of tools to gather troubleshooting information from a system   
</span></span><span style=display:flex><span><span>#</span> rpm <span style=font-weight:700>package</span> summary info
</span></span><span style=display:flex><span>Name: sos                         											  
</span></span><span style=display:flex><span><span>#</span> rpm <span style=font-weight:700>package</span> name
</span></span><span style=display:flex><span>Version: 3.6																  
</span></span><span style=display:flex><span><span>#</span> rpm <span style=font-weight:700>package</span> version
</span></span><span style=display:flex><span>Release: 1%{<span>?</span>dist}															  
</span></span><span style=display:flex><span><span>#</span> rpm release number
</span></span><span style=display:flex><span>Group: Applications/System     												  
</span></span><span style=display:flex><span><span>#</span> rpm group name
</span></span><span style=display:flex><span>Source0: http:<span style=font-style:italic>//people.redhat.com/breeves/sos/releases/sos-%{version}.tar.gz  
</span></span></span><span style=display:flex><span><span style=font-style:italic></span><span>#</span> rpm software tar <span style=font-weight:700>package</span> name, abs path
</span></span><span style=display:flex><span>License: GPLv2+																  
</span></span><span style=display:flex><span><span>#</span> rpm license
</span></span><span style=display:flex><span>BuildRoot: %{_tmppath}/%{name}-%{version}-%{release}-buildroot                
</span></span><span style=display:flex><span><span>#</span> rpm build path
</span></span><span style=display:flex><span>BuildArch: noarch   													      
</span></span><span style=display:flex><span><span>#</span> rpm arch version: x86_64/noarch/i686
</span></span><span style=display:flex><span>Url: http:<span style=font-style:italic>//fedorahosted.org/sos
</span></span></span><span style=display:flex><span><span style=font-style:italic></span>BuildRequires: python-devel													  
</span></span><span style=display:flex><span><span>#</span> rpm build dependency <span style=font-weight:700>package</span>
</span></span><span style=display:flex><span>BuildRequires: gettext														  
</span></span><span style=display:flex><span><span>#</span> ...
</span></span><span style=display:flex><span>BuildRequires: python-six													  
</span></span><span style=display:flex><span><span>#</span> ...
</span></span><span style=display:flex><span>Requires: libxml2-python													  
</span></span><span style=display:flex><span><span>#</span> rpm install dependency <span style=font-weight:700>package</span>
</span></span><span style=display:flex><span>Requires: rpm-python														  
</span></span><span style=display:flex><span><span>#</span> ...
</span></span><span style=display:flex><span>Requires: tar
</span></span><span style=display:flex><span>Requires: bzip2
</span></span><span style=display:flex><span>Requires: xz
</span></span><span style=display:flex><span>Requires: python-six
</span></span><span style=display:flex><span>Requires: python-futures
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>%description																  
</span></span><span style=display:flex><span><span>#</span> rpm <span style=font-weight:700>package</span> description
</span></span><span style=display:flex><span>Sos is a set of tools that gathers information about system
</span></span><span style=display:flex><span>hardware and configuration. The information can then be used <span style=font-weight:700>for</span>
</span></span><span style=display:flex><span>diagnostic purposes and debugging. Sos is commonly used to help
</span></span><span style=display:flex><span>support technicians and developers.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>%prep
</span></span><span style=display:flex><span>%setup -q
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>%build
</span></span><span style=display:flex><span>make																		  
</span></span><span style=display:flex><span><span>#</span> rpm build method: make/setup.py
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>%install																	  
</span></span><span style=display:flex><span><span>#</span> perform operations when the <span style=font-weight:700>package</span> is installed
</span></span><span style=display:flex><span>rm -rf <span>$</span>{RPM_BUILD_ROOT}
</span></span><span style=display:flex><span>make DESTDIR=<span>$</span>{RPM_BUILD_ROOT} install
</span></span><span style=display:flex><span>%find_lang %{name} || echo 0
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>%clean 																		  
</span></span><span style=display:flex><span><span>#</span> perform operations when rpm <span style=font-weight:700>package</span> build success
</span></span><span style=display:flex><span>rm -rf <span>$</span>{RPM_BUILD_ROOT}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>%files -f %{name}.lang     													  
</span></span><span style=display:flex><span><span>#</span> rpm install software file path
</span></span><span style=display:flex><span>%defattr(-,root,root,-)
</span></span><span style=display:flex><span>%{_sbindir}/sosreport
</span></span><span style=display:flex><span>%{_datadir}/%{name}
</span></span><span style=display:flex><span>%{python_sitelib}/*
</span></span><span style=display:flex><span>%{_mandir}/man1/*
</span></span><span style=display:flex><span>%{_mandir}/man5/*
</span></span><span style=display:flex><span>%doc AUTHORS README.md LICENSE
</span></span><span style=display:flex><span>%doc /usr/share/doc/sos/html
</span></span><span style=display:flex><span>%config(noreplace) %{_sysconfdir}/sos.conf
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>%changelog																	  
</span></span><span style=display:flex><span><span>#</span> software changelog
</span></span><span style=display:flex><span>* Thu Nov 02 2017 Bryn M. Reeves &lt;bmr<span>@</span>redhat.com&gt; = 3.5
</span></span><span style=display:flex><span>- New upstream release
</span></span></code></pre></div><p>可以看到，SPEC 文件的编写要指定的东西还是很多的，我们需要配置好每一项所做的操作，才能保证软件正确安装。</p><p><code>{_datadir}</code>, <code>{_mandir}</code> 等类似的宏定义，可以查看 <a href=https://fedoraproject.org/wiki/Packaging:RPMMacros>Fedora 维基</a> 了解详情。</p><h4 id=构建>构建
<a class=heading-link href=#%e6%9e%84%e5%bb%ba><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>上述操作均完成后，我们可以进行真正的构建操作了，执行 <code>rpmbuild -ba sos.spec</code> ，如果构建成功后，我们可以再 <code>/root/rpmbuild/SRPMS/</code> <code>/root/rpmbuild/RPMS</code> 下看到对应的 RPM 源文件包和 RPM 软件包，SRPMS 内的软件包，可以让我们之后的构建更轻松，如果不更改 spec 时，我们可以直接 <code>rpm -ivh sos*src.rpm</code> 安装后，即可再次执行 <code>rpmbuild -ba sos.spec</code> 进行构建。</p><h4 id=验证-rpm-正确性>验证 RPM 正确性
<a class=heading-link href=#%e9%aa%8c%e8%af%81-rpm-%e6%ad%a3%e7%a1%ae%e6%80%a7><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>最简单的验证方式就是在测试环境中安装刚刚构建出的软件包，如果相应的配置、源文件已经在正确的路径下，则安装成功。</p><h3 id=fpm>FPM
<a class=heading-link href=#fpm><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h3><h4 id=概念>概念
<a class=heading-link href=#%e6%a6%82%e5%bf%b5><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>什么是 FPM？ FPM 是一个命令行工具用于构建软件包，软件包来源支持的种类很多，如: dir/gem/rpm/python/pear 等等。
通过 FPM 我们可以很轻松的构建 RPM，不用再编写那一堆 spec 文件中的参数了。所有参数都可以通过命令行 option 的方式添加，方便快捷。</p><h4 id=安装>安装
<a class=heading-link href=#%e5%ae%89%e8%a3%85><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>从 <a href=https://rubygems.org/>https://rubygems.org/</a> 下载并安装 gem。也可以通过 yum install ruby-devel gcc 方式安装。
安装完成后，默认的 gem 源指定的是国外的，我们可以替换成 taobao ：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>gem source --remove https://rubygems.org/
</span></span><span style=display:flex><span>gem source --add https://ruby.taobao.org
</span></span></code></pre></div><p>然后执行 gem install fpm 记了。</p><h4 id=使用>使用
<a class=heading-link href=#%e4%bd%bf%e7%94%a8><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h4><p>如果我们要构建一个 python 软件包，如 pyroute2。我们可以这样操作：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>root<span>@</span>yiran-30-250:<span>~</span>
</span></span><span style=display:flex><span> <span>$</span> fpm -s python -t rpm -a noarch -n python2-pyroute2 pyroute2
</span></span><span style=display:flex><span>Created <span style=font-weight:700>package</span> {:path=&gt;<span style=font-style:italic>&#34;python2-pyroute2-0.5.2-1.noarch.rpm&#34;</span>}
</span></span><span style=display:flex><span>root<span>@</span>yiran-30-250:<span>~</span>
</span></span><span style=display:flex><span> <span>$</span> ll -trh |grep python2-pyroute2
</span></span><span style=display:flex><span>-rw-r--r--  1 root root 208K 7月  28 07:50 python2-pyroute2-0.5.2-1.noarch.rpm
</span></span></code></pre></div><p>只需一条命令就可以自动从 pypi 上下载源软件包并构建出对应的 rpm。</p><p>如果我们此时不止要构建 rpm，还要指定 rpm 的依赖关系，我们可以这样做：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>root<span>@</span>yiran-30-250:<span>~</span>
</span></span><span style=display:flex><span> <span>$</span> fpm -s python -t rpm -a x86_64 -n python2-crypto -v 2.6.1 --iteration 1.el7 --depends <span style=font-style:italic>&#34;python-pycrypto&#34;</span>
</span></span><span style=display:flex><span>Created <span style=font-weight:700>package</span> {:path=&gt;<span style=font-style:italic>&#34;python2-crypto-2.6.1-1.el7.x86_64.rpm&#34;</span>}
</span></span><span style=display:flex><span>root<span>@</span>yiran-30-250:<span>~</span>
</span></span><span style=display:flex><span> <span>$</span> ll -trh |grep python2-crypto
</span></span><span style=display:flex><span>-rw-r--r--  1 root root 1.5K 7月  28 07:52 python2-crypto-2.6.1-1.el7.x86_64.rpm
</span></span><span style=display:flex><span>root<span>@</span>yiran-30-250:<span>~</span>
</span></span><span style=display:flex><span> <span>$</span> rpm -qpR python2-crypto-2.6.1-1.el7.x86_64.rpm
</span></span><span style=display:flex><span>python-pycrypto
</span></span><span style=display:flex><span>rpmlib(PayloadFilesHavePrefix) &lt;= 4.0-1
</span></span><span style=display:flex><span>rpmlib(CompressedFileNames) &lt;= 3.0.4-1
</span></span></code></pre></div><h2 id=总结>总结
<a class=heading-link href=#%e6%80%bb%e7%bb%93><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>日常用到的 RPM，推荐还是 Google，基本上常见版本都会有。如果我们要构建自己需要的指定版本第三方 RPM，推荐使用 FPM 的方式，可以省去很多烦恼。
但是如果我们需要对自己编写、维护的软件进行 RPM 构建，那还是推荐 rpmbuild 方式，毕竟可以指定 RPM 安装前，安装时，安装后的所有操作，可以根据自己需求定义操作，很强大。</p><h2 id=吐槽>吐槽
<a class=heading-link href=#%e5%90%90%e6%a7%bd><i class="fa fa-link" aria-hidden=true title="Link to heading"></i>
<span class=sr-only>Link to heading</span></a></h2><p>目前主要工作是使用 Python。在 Python 引入第三方依赖时，软件包名字很头疼，如果软件包名不同，但是源文件是相同的，RPM 安装时会提示软件包冲突，此时就需要自己去解决冲突，如果要安装的软件依赖于 A，系统已经安装了 B，目前我常用的方式有：</p><ol><li>rpm -ivh A &ndash;replacefiles # 强制安装 A</li><li>rpm -e B &ndash;nodeps ; rpm -ivh A # 因为 A 与 B 源文件相同，在版本相同的情况下，这种方式是最快的解决办法</li><li>Build 一个空的软件包，名字为 A，依赖于 B。 这样我们可以直接安装 A，因为 A 是空的，不做任何操作，安装完 A 后，系统同时存在 A & B，此时再安装依赖于 A 的软件就可以正常安装了</li></ol><p>目前已经见过以下几种 Python RPM 命名方式了：</p><ol><li>python-pyroute2</li><li>python2-pyroute2</li><li>pyroute2</li><li>&mldr;</li></ol><p>真是无力吐槽啊。。。。</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//zdyxry.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2023
Yiran Zhou
·
Powered by <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0433XDZ3V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G0433XDZ3V",{anonymize_ip:!1})}</script></body></html>