<!doctype html><html lang=zh-cn><head><title>Shell 携带通配符执行顺序 · Yiran's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yiran Zhou"><meta name=description content="背景 链接到标题 这周有同事在 Slack 问了一个问题： 发现在v505和v503的集群主机上 sudo的配置有一点点小问题：普通用户使用sudo时 shell中的 wildcard不生效 。
环境状态大概是这样的： 系统存在普通用户 yiran ，并配置了 sudo 权限，同时系统存在 /var/log/libvirt/qemu/ 路径，其中 libvirt 和 qemu 的目录 owner 是 root，权限是700， qemu 下存在很多以 .log 为结尾的文件，owner 是 root，权限是 600，具体示例如下：
[yiran@node11 11:09:35 ~]$id yiran uid=1002(yiran) gid=1002(yiran) groups=1002(yiran) [yiran@node11 11:09:40 ~]$sudo ls -l /var/log/ |grep libvirt drwx------. 3 root root 4096 Sep 16 2022 libvirt [yiran@node11 11:09:45 ~]$sudo ls -l /var/log/libvirt |grep qemu drwx------. 2 root root 319488 Mar 26 03:07 qemu [yiran@node11 11:09:48 ~]$sudo ls -l /var/log/libvirt/qemu/ |egrep *."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Shell 携带通配符执行顺序"><meta name=twitter:description content="背景 链接到标题 这周有同事在 Slack 问了一个问题： 发现在v505和v503的集群主机上 sudo的配置有一点点小问题：普通用户使用sudo时 shell中的 wildcard不生效 。
环境状态大概是这样的： 系统存在普通用户 yiran ，并配置了 sudo 权限，同时系统存在 /var/log/libvirt/qemu/ 路径，其中 libvirt 和 qemu 的目录 owner 是 root，权限是700， qemu 下存在很多以 .log 为结尾的文件，owner 是 root，权限是 600，具体示例如下：
[yiran@node11 11:09:35 ~]$id yiran uid=1002(yiran) gid=1002(yiran) groups=1002(yiran) [yiran@node11 11:09:40 ~]$sudo ls -l /var/log/ |grep libvirt drwx------. 3 root root 4096 Sep 16 2022 libvirt [yiran@node11 11:09:45 ~]$sudo ls -l /var/log/libvirt |grep qemu drwx------. 2 root root 319488 Mar 26 03:07 qemu [yiran@node11 11:09:48 ~]$sudo ls -l /var/log/libvirt/qemu/ |egrep *."><meta property="og:title" content="Shell 携带通配符执行顺序"><meta property="og:description" content="背景 链接到标题 这周有同事在 Slack 问了一个问题： 发现在v505和v503的集群主机上 sudo的配置有一点点小问题：普通用户使用sudo时 shell中的 wildcard不生效 。
环境状态大概是这样的： 系统存在普通用户 yiran ，并配置了 sudo 权限，同时系统存在 /var/log/libvirt/qemu/ 路径，其中 libvirt 和 qemu 的目录 owner 是 root，权限是700， qemu 下存在很多以 .log 为结尾的文件，owner 是 root，权限是 600，具体示例如下：
[yiran@node11 11:09:35 ~]$id yiran uid=1002(yiran) gid=1002(yiran) groups=1002(yiran) [yiran@node11 11:09:40 ~]$sudo ls -l /var/log/ |grep libvirt drwx------. 3 root root 4096 Sep 16 2022 libvirt [yiran@node11 11:09:45 ~]$sudo ls -l /var/log/libvirt |grep qemu drwx------. 2 root root 319488 Mar 26 03:07 qemu [yiran@node11 11:09:48 ~]$sudo ls -l /var/log/libvirt/qemu/ |egrep *."><meta property="og:type" content="article"><meta property="og:url" content="https://zdyxry.github.io/2023/04/01/Shell-%E6%90%BA%E5%B8%A6%E9%80%9A%E9%85%8D%E7%AC%A6%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-01T00:00:00+00:00"><meta property="article:modified_time" content="2023-04-01T00:00:00+00:00"><link rel=canonical href=https://zdyxry.github.io/2023/04/01/Shell-%E6%90%BA%E5%B8%A6%E9%80%9A%E9%85%8D%E7%AC%A6%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.76ce9bad7ac9bd368d486c6e91e7e0906fff71d9d35ccbf93959a375e2bf50e5.css integrity="sha256-ds6brXrJvTaNSGxukefgkG//cdnTXMv5OVmjdeK/UOU=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/yiran.png sizes=32x32><link rel=icon type=image/png href=/images/yiran.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.101.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Yiran's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/friends/>Friends</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://zdyxry.github.io/2023/04/01/Shell-%E6%90%BA%E5%B8%A6%E9%80%9A%E9%85%8D%E7%AC%A6%E6%89%A7%E8%A1%8C%E9%A1%BA%E5%BA%8F/>Shell 携带通配符执行顺序</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2023-04-01T00:00:00Z>April 1, 2023</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
阅读时间：2 分钟</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/Shell/>Shell</a></span></div></div></header><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#原因>原因</a></li><li><a href=#参考链接>参考链接</a></li></ul></nav><div class=post-content><h2 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>这周有同事在 Slack 问了一个问题： <code>发现在v505和v503的集群主机上 sudo的配置有一点点小问题：普通用户使用sudo时 shell中的 wildcard不生效</code> 。</p><p>环境状态大概是这样的：
系统存在普通用户 <code>yiran</code> ，并配置了 sudo 权限，同时系统存在 <code>/var/log/libvirt/qemu/</code> 路径，其中 <code>libvirt</code> 和 <code>qemu</code> 的目录 owner 是 root，权限是700， <code>qemu</code> 下存在很多以 <code>.log</code> 为结尾的文件，owner 是 root，权限是 600，具体示例如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>[yiran<span>@</span>node11 11:09:35 <span>~</span>]<span>$</span>id yiran
</span></span><span style=display:flex><span>uid=1002(yiran) gid=1002(yiran) groups=1002(yiran)
</span></span><span style=display:flex><span>[yiran<span>@</span>node11 11:09:40 <span>~</span>]<span>$</span>sudo ls -l /<span style=font-weight:700>var</span>/log/ |grep libvirt
</span></span><span style=display:flex><span>drwx------.  3 root      root           4096 Sep 16  2022 libvirt
</span></span><span style=display:flex><span>[yiran<span>@</span>node11 11:09:45 <span>~</span>]<span>$</span>sudo ls -l /<span style=font-weight:700>var</span>/log/libvirt |grep qemu
</span></span><span style=display:flex><span>drwx------. 2 root root 319488 Mar 26 03:07 qemu
</span></span><span style=display:flex><span>[yiran<span>@</span>node11 11:09:48 <span>~</span>]<span>$</span>sudo ls -l /<span style=font-weight:700>var</span>/log/libvirt/qemu/ |egrep *.log<span>$</span> | head -n 3
</span></span><span style=display:flex><span>-rw------- 1 root root   0 Mar 26 03:07 00381379-c866-4aee-b22d-af0c63367d0b.log
</span></span><span style=display:flex><span>-rw------- 1 root root   0 Mar 26 03:07 003a4849-a0c4-4ea1-947b-1bbd9b162c7c.log
</span></span><span style=display:flex><span>-rw------- 1 root root   0 Mar 26 03:07 00625e93-ec6e-45e1-b2b9-7ec15c94d803.log
</span></span></code></pre></div><p>同事执行的命令是： <code>sudo ls /var/log/libvirt/qemu/*.log</code> ，系统提示 <code>No such file or directory</code> ， 问原因。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>[yiran<span>@</span>node11 11:11:42 <span>~</span>]<span>$</span>sudo ls /<span style=font-weight:700>var</span>/log/libvirt/qemu/*.log
</span></span><span style=display:flex><span>ls: cannot access /<span style=font-weight:700>var</span>/log/libvirt/qemu/*.log: No such file or directory
</span></span></code></pre></div><h2 id=原因>原因
<a class=heading-link href=#%e5%8e%9f%e5%9b%a0><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>这个现象以及环境决定了这个很明显是一个权限相关的问题，直接 <code>strace</code> 看看，截取 5 行看看：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>[yiran<span>@</span>node11 11:17:08 <span>~</span>]<span>$</span>strace sudo ls /<span style=font-weight:700>var</span>/log/libvirt/qemu<span style=font-style:italic>/*.log 2&gt;&amp;1 | head -n 5
</span></span></span><span style=display:flex><span><span style=font-style:italic>execve(&#34;/bin/sudo&#34;, [&#34;sudo&#34;, &#34;ls&#34;, &#34;/var/log/libvirt/qemu/*.log&#34;], [/* 21 vars */</span>]) = 0
</span></span><span style=display:flex><span>brk(NULL)                               = 0x558432932000
</span></span><span style=display:flex><span>fcntl(0, F_GETFD)                       = 0
</span></span><span style=display:flex><span>fcntl(1, F_GETFD)                       = 0
</span></span><span style=display:flex><span>fcntl(2, F_GETFD)                       = 0
</span></span></code></pre></div><p>换一个可以正常输出的例子对比一下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>[yiran<span>@</span>node11 11:18:58 <span>~</span>]<span>$</span>strace sudo ls /<span style=font-weight:700>var</span>/log<span style=font-style:italic>/*.log 2&gt;&amp;1 | head -n 5
</span></span></span><span style=display:flex><span><span style=font-style:italic>execve(&#34;/bin/sudo&#34;, [&#34;sudo&#34;, &#34;ls&#34;, &#34;/var/log/bash.log&#34;, &#34;/var/log/boot.log&#34;, &#34;/var/log/configcenter-agent.log&#34;, &#34;/var/log/detect_conn.log&#34;, &#34;/var/log/hugepage-manager.log&#34;, &#34;/var/log/ntp.log&#34;, &#34;/var/log/ovm-agent-init.log&#34;, &#34;/var/log/vector-agent.log&#34;, &#34;/var/log/websockify.log&#34;, &#34;/var/log/yum.log&#34;], [/* 21 vars */</span>]) = 0
</span></span><span style=display:flex><span>brk(NULL)                               = 0x556b5d5ac000
</span></span><span style=display:flex><span>fcntl(0, F_GETFD)                       = 0
</span></span><span style=display:flex><span>fcntl(1, F_GETFD)                       = 0
</span></span><span style=display:flex><span>fcntl(2, F_GETFD)                       = 0
</span></span></code></pre></div><p>可以看到传给 <code>execve</code> 的时候，前者是直接带有通配符，后者已经进行了模式匹配并展开为具体匹配的文件名。找 Bash 的<a href=https://www.gnu.org/software/bash/manual/bash.html#Filename-Expansion>官方文档</a>看看关于通配符的处理：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>After word splitting, unless the -f option has been set (see The Set Builtin), 
</span></span><span style=display:flex><span>Bash scans each word <span style=font-weight:700>for</span> the characters <span>‘</span>*<span>’</span>, <span>‘?’</span>, and <span>‘</span>[<span>’</span>. 
</span></span><span style=display:flex><span>If one of these characters appears, and is not quoted, 
</span></span><span style=display:flex><span>then the word is regarded as a pattern, and replaced with an alphabetically sorted 
</span></span><span style=display:flex><span>list of filenames matching the pattern (see Pattern Matching). 
</span></span><span style=display:flex><span>If no matching filenames are found, and the shell option nullglob is disabled, 
</span></span><span style=display:flex><span>the word is left unchanged. If the nullglob option is set, and no matches are found, 
</span></span><span style=display:flex><span>the word is removed. If the failglob shell option is set, and no matches are found, 
</span></span><span style=display:flex><span>an <span>error</span> message is printed and the command is not executed. If the shell option 
</span></span><span style=display:flex><span>nocaseglob is enabled, the match is performed without regard to the <span style=font-weight:700>case</span> of 
</span></span><span style=display:flex><span>alphabetic characters.
</span></span></code></pre></div><p>Bash 在进行参数进行分词后，会扫描每个单词中出现 <code>*</code> ，<code>?</code> 或者 <code>[</code> 的字符，如果出现，则认为这是一个 pattern，然后会进行模式匹配，将其替换为匹配到的结果，匹配过程也与 Bash <code>glob</code> 相关参数有关。</p><p>在内部环境中，执行命令的过程是，先分词进行解析，检测到 <code>*</code> 后，进行模式匹配，普通用户 <code>yiran</code> 是没有对 <code>/var/log/libvirt/qemu/</code> 目录的读取权限的，所以在进行模式匹配的时候，匹配不到对应的文件，导致真正传递的参数是 <code>*.log</code> 本身，而不是具体的文件名，像日常使用的 <code>ls</code> <code>cp</code> <code>mv</code> 经常会携带通配符来进行批量操作，这里使用的能力并不是执行的 <code>ls</code> <code>cp</code> <code>mv</code> 自身，而是 Shell 提供的模式匹配能力。</p><p>解决方式也很简单，只需要在 sudo 中执行一个新的 shell 就可以了：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>[yiran<span>@</span>node11 12:04:39 <span>~</span>]<span>$</span>sudo bash -c <span>&#39;</span>ls /<span style=font-weight:700>var</span>/log/libvirt/qemu/*.log<span>&#39;</span> | head -n 3
</span></span><span style=display:flex><span>/<span style=font-weight:700>var</span>/log/libvirt/qemu/00381379-c866-4aee-b22d-af0c63367d0b.log
</span></span><span style=display:flex><span>/<span style=font-weight:700>var</span>/log/libvirt/qemu/003a4849-a0c4-4ea1-947b-1bbd9b162c7c.log
</span></span><span style=display:flex><span>/<span style=font-weight:700>var</span>/log/libvirt/qemu/00625e93-ec6e-45e1-b2b9-7ec15c94d803.log
</span></span></code></pre></div><h2 id=参考链接>参考链接
<a class=heading-link href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><ul><li><a href=https://unix.stackexchange.com/questions/309244/why-isnt-this-sudo-mv-operation-with-wildcard-working>https://unix.stackexchange.com/questions/309244/why-isnt-this-sudo-mv-operation-with-wildcard-working</a></li></ul></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//zdyxry.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2024
Yiran Zhou
·
技术支持 <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0433XDZ3V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G0433XDZ3V",{anonymize_ip:!1})}</script></body></html>