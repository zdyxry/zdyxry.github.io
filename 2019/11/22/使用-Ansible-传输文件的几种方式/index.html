<!doctype html><html lang=zh-cn><head><title>使用 Ansible 传输文件的几种方式 · Yiran's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yiran Zhou"><meta name=description content="背景 链接到标题 Ansible 作为一款配置管理和应用部署的软件，日常使用的场景很多，我自己也是重度用户。最近在使用 Ansible 进行文件传输的时候踩了个坑，借此机会整理下 Ansible 传输文件的几种方式。
实验环境：
[root@yiran ~]# ansible --version ansible 2.7.12 config file = None configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Aug 7 2019, 00:51:29) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] Template 链接到标题 https://docs.ansible.com/ansible/latest/modules/template_module.html
Ansible 一个常用的功能就是配置管理，通过 Ansible 批量分发配置文件，达到统一版本管理的效果，如果我们想要进行少量的文件传输，从控制节点传输到被管理节点，那么可以采用这种方式来完成。
具体的使用官方文档 已经讲的很详细了，这里不再啰嗦。
因为版本是通过 Jinja2 模板传输，支持模板渲染 虽然我们可以在模版中不制定任何参数，直接将其拷贝，但是相比 Copy/Fetch 模块还是需要有模版渲染的一步，速度要慢一些
Copy/Fetch 模块 链接到标题 https://docs."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Ansible 传输文件的几种方式"><meta name=twitter:description content="背景 链接到标题 Ansible 作为一款配置管理和应用部署的软件，日常使用的场景很多，我自己也是重度用户。最近在使用 Ansible 进行文件传输的时候踩了个坑，借此机会整理下 Ansible 传输文件的几种方式。
实验环境：
[root@yiran ~]# ansible --version ansible 2.7.12 config file = None configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Aug 7 2019, 00:51:29) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] Template 链接到标题 https://docs.ansible.com/ansible/latest/modules/template_module.html
Ansible 一个常用的功能就是配置管理，通过 Ansible 批量分发配置文件，达到统一版本管理的效果，如果我们想要进行少量的文件传输，从控制节点传输到被管理节点，那么可以采用这种方式来完成。
具体的使用官方文档 已经讲的很详细了，这里不再啰嗦。
因为版本是通过 Jinja2 模板传输，支持模板渲染 虽然我们可以在模版中不制定任何参数，直接将其拷贝，但是相比 Copy/Fetch 模块还是需要有模版渲染的一步，速度要慢一些
Copy/Fetch 模块 链接到标题 https://docs."><meta property="og:title" content="使用 Ansible 传输文件的几种方式"><meta property="og:description" content="背景 链接到标题 Ansible 作为一款配置管理和应用部署的软件，日常使用的场景很多，我自己也是重度用户。最近在使用 Ansible 进行文件传输的时候踩了个坑，借此机会整理下 Ansible 传输文件的几种方式。
实验环境：
[root@yiran ~]# ansible --version ansible 2.7.12 config file = None configured module search path = [u'/root/.ansible/plugins/modules', u'/usr/share/ansible/plugins/modules'] ansible python module location = /usr/lib/python2.7/site-packages/ansible executable location = /usr/bin/ansible python version = 2.7.5 (default, Aug 7 2019, 00:51:29) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] Template 链接到标题 https://docs.ansible.com/ansible/latest/modules/template_module.html
Ansible 一个常用的功能就是配置管理，通过 Ansible 批量分发配置文件，达到统一版本管理的效果，如果我们想要进行少量的文件传输，从控制节点传输到被管理节点，那么可以采用这种方式来完成。
具体的使用官方文档 已经讲的很详细了，这里不再啰嗦。
因为版本是通过 Jinja2 模板传输，支持模板渲染 虽然我们可以在模版中不制定任何参数，直接将其拷贝，但是相比 Copy/Fetch 模块还是需要有模版渲染的一步，速度要慢一些
Copy/Fetch 模块 链接到标题 https://docs."><meta property="og:type" content="article"><meta property="og:url" content="https://zdyxry.github.io/2019/11/22/%E4%BD%BF%E7%94%A8-Ansible-%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-11-22T20:15:17+00:00"><meta property="article:modified_time" content="2019-11-22T20:15:17+00:00"><link rel=canonical href=https://zdyxry.github.io/2019/11/22/%E4%BD%BF%E7%94%A8-Ansible-%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.01bd429dda63a16d76996eaf0b8da061429b76e714515cb1b246aac7fe7f4b2a.css integrity="sha256-Ab1CndpjoW12mW6vC42gYUKbducUUVyxskaqx/5/Syo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/yiran.png sizes=32x32><link rel=icon type=image/png href=/images/yiran.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.101.0"></head><body class="preload-transitions colorscheme-dark"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Yiran's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/friends/>Friends</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://zdyxry.github.io/2019/11/22/%E4%BD%BF%E7%94%A8-Ansible-%E4%BC%A0%E8%BE%93%E6%96%87%E4%BB%B6%E7%9A%84%E5%87%A0%E7%A7%8D%E6%96%B9%E5%BC%8F/>使用 Ansible 传输文件的几种方式</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-11-22T20:15:17Z>November 22, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
阅读时间：2 分钟</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/Linux/>Linux</a></span>
<span class=separator>•</span>
<span class=tag><a href=/tags/Ansible/>Ansible</a></span></div></div></header><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#template>Template</a></li><li><a href=#copyfetch-模块>Copy/Fetch 模块</a><ul><li><a href=#不算坑的坑>不算坑的坑</a></li></ul></li><li><a href=#synchronize>Synchronize</a><ul><li><a href=#坑>坑</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考链接>参考链接</a></li></ul></nav><div class=post-content><h2 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>Ansible 作为一款配置管理和应用部署的软件，日常使用的场景很多，我自己也是重度用户。最近在使用 Ansible 进行文件传输的时候踩了个坑，借此机会整理下 Ansible 传输文件的几种方式。</p><p>实验环境：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@yiran ~]<span style=font-style:italic># ansible --version</span>
</span></span><span style=display:flex><span>ansible 2.7.12
</span></span><span style=display:flex><span>  config file = None
</span></span><span style=display:flex><span>  configured module search path = [u<span style=font-style:italic>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span style=font-style:italic>&#39;/usr/share/ansible/plugins/modules&#39;</span>]
</span></span><span style=display:flex><span>  ansible python module location = /usr/lib/python2.7/site-packages/ansible
</span></span><span style=display:flex><span>  executable location = /usr/bin/ansible
</span></span><span style=display:flex><span>  python version = 2.7.5 (default, Aug  7 2019, 00:51:29) [GCC 4.8.5 20150623 (Red Hat 4.8.5-39)]
</span></span></code></pre></div><h2 id=template>Template
<a class=heading-link href=#template><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p><a href=https://docs.ansible.com/ansible/latest/modules/template_module.html>https://docs.ansible.com/ansible/latest/modules/template_module.html</a></p><p>Ansible 一个常用的功能就是配置管理，通过 Ansible 批量分发配置文件，达到统一版本管理的效果，如果我们想要进行少量的文件传输，从控制节点传输到被管理节点，那么可以采用这种方式来完成。</p><p>具体的使用<a href=https://docs.ansible.com/ansible/latest/modules/template_module.html>官方文档</a> 已经讲的很详细了，这里不再啰嗦。</p><p>因为版本是通过 Jinja2 模板传输，支持模板渲染
虽然我们可以在模版中不制定任何参数，直接将其拷贝，但是相比 Copy/Fetch 模块还是需要有模版渲染的一步，速度要慢一些</p><h2 id=copyfetch-模块>Copy/Fetch 模块
<a class=heading-link href=#copyfetch-%e6%a8%a1%e5%9d%97><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p><a href=https://docs.ansible.com/ansible/latest/modules/copy_module.html>https://docs.ansible.com/ansible/latest/modules/copy_module.html</a></p><p><a href=https://docs.ansible.com/ansible/latest/modules/fetch_module.html>https://docs.ansible.com/ansible/latest/modules/fetch_module.html</a></p><p>如果说我们通过模板来传输文件优点歪门邪道，那么通过 Copy/Fetch 就是 Ansible 官方提供的两个正统模块。</p><p>Copy 用于把文件（或文件夹）从控制节点（或远程节点）分发到被管理节点，Copy 在拷贝过程中不会修改文件中的内容或编码，仅仅做传输工作。</p><p>Fetch 用于从被管理节点传输文件到控制节点。需要注意的是 Fetch 只能拉取文件，而 Copy 是可以传输文件或者文件夹的。</p><h3 id=不算坑的坑>不算坑的坑
<a class=heading-link href=#%e4%b8%8d%e7%ae%97%e5%9d%91%e7%9a%84%e5%9d%91><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>在使用 Copy/Fetch 时，总体感受是比较好的，但是有一点需要注意，如果你拷贝的文件过多，或者单个文件大小过大，那么最好不要使用 Copy/Fetch。</p><p>Ansible 默认配置中，使用 SFTP 作为文件传输协议：</p><blockquote><p>There’s really no reason to change this unless problems are encountered, and then there’s also no real drawback to managing the switch. Most environments support SFTP by default and this doesn’t usually need to be changed.</p></blockquote><p>SFTP 是基于 SSH 协议的，与 FTP 没啥关系。SFTP 并不以性能渐长，甚至可以说性能很差，至少与 FTP、Rsync 没办法相比。</p><p>关于 SFTP 为什么速度这么慢，StackOverFlow 有个回答写的很详细，这里引用一段：</p><blockquote><p>I&rsquo;m the author of HPN-SSH and I was asked by a commenter here to weigh in. I&rsquo;d like to start with a couple of background items. First off, it&rsquo;s important to keep in mind that SSHv2 is a multiplexed protocol - multiple channels over a single TCP connection. As such, the SSH channels are essentially unaware of the underlying flow control algorithm used by TCP. This means that SSHv2 has to implement its own flow control algorithm. The most common implementation basically reimplements sliding windows. The means that you have the SSH sliding window riding on top of the TCP sliding window. The end results is that the effective size of the receive buffer is the minimum of the receive buffers of the two sliding windows.</p></blockquote><h2 id=synchronize>Synchronize
<a class=heading-link href=#synchronize><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>上面提到的两个模块性能都不好，总会有个性能好的来解决这个问题，就是 Synchronize。Synchronize 是通过 rsync 来达到文件传输的目的，是 rsync 的封装。</p><p>在使用上因为是调用的 rsync，所以控制节点需要安装 rsync ，Synchronize 模块的并不会完全实现 rsync 所有功能，只是通过 rsync 来达到我们想要的快速同步的功能。</p><h3 id=坑>坑
<a class=heading-link href=#%e5%9d%91><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>在使用 Ansible 过程中，通常会使用普通用户配合密钥的形式来进行用户验证，如果需要 root 权限那么通过 become 关键字来提权。</p><p>在 sudo 的早期版本中， <code>/etc/sudoers</code> 中有这么一条配置，高版本取消了 tty 的限制：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>#
</span></span><span style=display:flex><span># Disable &#34;ssh hostname sudo &lt;cmd&gt;&#34;, because it will show the password in clear.
</span></span><span style=display:flex><span>#         You have to run &#34;ssh -t hostname sudo &lt;cmd&gt;&#34;.
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span>Defaults    requiretty
</span></span></code></pre></div><p>这个配置会导致 Ansible 调用 rsync 执行时失败，可以通过修改 <code>/etc/sudoers</code> 或者升级 sudo 软件包来解决。</p><h2 id=总结>总结
<a class=heading-link href=#%e6%80%bb%e7%bb%93><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>那么说了以上这三种方式，就需要来一个总结对比，看看什么场景下使用什么模块更方便：</p><table><thead><tr><th>模块</th><th>传输文件</th><th>传输文件夹</th><th>文件修改</th><th>文件编码</th><th>速度</th><th>文件源</th><th>权限配置</th><th>文件验证</th></tr></thead><tbody><tr><td>Template</td><td>Y</td><td>N</td><td>Y</td><td>Y</td><td>慢</td><td>控制节点</td><td>Y</td><td>Y</td></tr><tr><td>Copy/Fetch</td><td>Y</td><td>Y/N</td><td>N</td><td>N</td><td>慢</td><td>控制节点/远程节点</td><td>Y</td><td>Y</td></tr><tr><td>Synchronize</td><td>N</td><td>Y</td><td>N</td><td>N</td><td>快</td><td>控制节点</td><td>Y</td><td>N</td></tr></tbody></table><p>各个模块没有具体的好坏，全看个人需求来使用合适的模块就好。</p><h2 id=参考链接>参考链接
<a class=heading-link href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><ul><li><a href=https://docs.ansible.com/ansible/latest/modules/template_module.html>https://docs.ansible.com/ansible/latest/modules/template_module.html</a></li><li><a href=https://daniel.haxx.se/blog/2010/12/08/making-sftp-transfers-fast/>https://daniel.haxx.se/blog/2010/12/08/making-sftp-transfers-fast/</a></li><li><a href=https://stackoverflow.com/questions/8849240/why-when-i-transfer-a-file-through-sftp-it-takes-longer-than-ftp>https://stackoverflow.com/questions/8849240/why-when-i-transfer-a-file-through-sftp-it-takes-longer-than-ftp</a></li></ul></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//zdyxry.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2023
Yiran Zhou
·
技术支持 <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0433XDZ3V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G0433XDZ3V",{anonymize_ip:!1})}</script></body></html>