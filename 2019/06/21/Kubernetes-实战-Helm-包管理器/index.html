<!doctype html><html lang=zh-cn><head><title>Kubernetes 实战-Helm 包管理器 · Yiran's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yiran Zhou"><meta name=description content="简介 链接到标题 Helm 就是k8s 的包管理器 。常见的包管理器有：yum,apt,pip&mldr;
包管理器基础功能有：
安装 依赖安装 升级 回滚 卸载 源管理 搜索 &mldr; 基本概念 链接到标题 Helm: Kubernetes的包管理工具，命令行同名
Tiller: Helmv2 的服务端，用于接收并处理 Helm 发送的请求，默认以 Deployment 形式部署在 k8s 集群中
Chart: Helm 包管理的基础单元，等同于 RPM
Repoistory: Helm的软件源仓库，是一个 Web 服务器，路径下除了响应的软件 Chart 包之外，维护了一个 index.yaml 用于索引
Release: Helm 安装在 Kubernetes 集群中的 Chart 实例
现状 链接到标题 helm 截至06月20日最新稳定版本为 v2.14.1。
在05月16日发布了 v3.0 alpha 版本，根据相关文档描述，v2 无法平滑升级到 v3 版本。
注：存在部分小版本无法平滑升级情况。
helm v3 版本改进：
在 v2 版本设计中，需要单独创建属于 Tiller 的 ServiceAccount，授权 clusteradmin 权限，以为着只要你有 helm 权限，那么你有操作 k8s全集群所有权限。在 v3 版本中删除 Tiller，直接与 k8s api 进行通信，权限管理更清晰 helm 提供 libary 模板引擎切换为 Lua 目前通过 Hook 方式创建的资源，helm 后续不会管理，在 v3 会增加管理 Hook 资源功能 目前所有配置保存在 cm 中，后续考虑保存到 secret v2 需要单独维护仓库，v3 中可以将 Chart 推送到 Docker 镜像仓库中，提供 helm push/login 功能 &mldr; Helm2 基本使用 链接到标题 安装 链接到标题 在 Helm Github Release 下载最新版本二进制文件，并在本地解压。"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Kubernetes 实战-Helm 包管理器"><meta name=twitter:description content="简介 链接到标题 Helm 就是k8s 的包管理器 。常见的包管理器有：yum,apt,pip&mldr;
包管理器基础功能有：
安装 依赖安装 升级 回滚 卸载 源管理 搜索 &mldr; 基本概念 链接到标题 Helm: Kubernetes的包管理工具，命令行同名
Tiller: Helmv2 的服务端，用于接收并处理 Helm 发送的请求，默认以 Deployment 形式部署在 k8s 集群中
Chart: Helm 包管理的基础单元，等同于 RPM
Repoistory: Helm的软件源仓库，是一个 Web 服务器，路径下除了响应的软件 Chart 包之外，维护了一个 index.yaml 用于索引
Release: Helm 安装在 Kubernetes 集群中的 Chart 实例
现状 链接到标题 helm 截至06月20日最新稳定版本为 v2.14.1。
在05月16日发布了 v3.0 alpha 版本，根据相关文档描述，v2 无法平滑升级到 v3 版本。
注：存在部分小版本无法平滑升级情况。
helm v3 版本改进：
在 v2 版本设计中，需要单独创建属于 Tiller 的 ServiceAccount，授权 clusteradmin 权限，以为着只要你有 helm 权限，那么你有操作 k8s全集群所有权限。在 v3 版本中删除 Tiller，直接与 k8s api 进行通信，权限管理更清晰 helm 提供 libary 模板引擎切换为 Lua 目前通过 Hook 方式创建的资源，helm 后续不会管理，在 v3 会增加管理 Hook 资源功能 目前所有配置保存在 cm 中，后续考虑保存到 secret v2 需要单独维护仓库，v3 中可以将 Chart 推送到 Docker 镜像仓库中，提供 helm push/login 功能 &mldr; Helm2 基本使用 链接到标题 安装 链接到标题 在 Helm Github Release 下载最新版本二进制文件，并在本地解压。"><meta property="og:title" content="Kubernetes 实战-Helm 包管理器"><meta property="og:description" content="简介 链接到标题 Helm 就是k8s 的包管理器 。常见的包管理器有：yum,apt,pip&mldr;
包管理器基础功能有：
安装 依赖安装 升级 回滚 卸载 源管理 搜索 &mldr; 基本概念 链接到标题 Helm: Kubernetes的包管理工具，命令行同名
Tiller: Helmv2 的服务端，用于接收并处理 Helm 发送的请求，默认以 Deployment 形式部署在 k8s 集群中
Chart: Helm 包管理的基础单元，等同于 RPM
Repoistory: Helm的软件源仓库，是一个 Web 服务器，路径下除了响应的软件 Chart 包之外，维护了一个 index.yaml 用于索引
Release: Helm 安装在 Kubernetes 集群中的 Chart 实例
现状 链接到标题 helm 截至06月20日最新稳定版本为 v2.14.1。
在05月16日发布了 v3.0 alpha 版本，根据相关文档描述，v2 无法平滑升级到 v3 版本。
注：存在部分小版本无法平滑升级情况。
helm v3 版本改进：
在 v2 版本设计中，需要单独创建属于 Tiller 的 ServiceAccount，授权 clusteradmin 权限，以为着只要你有 helm 权限，那么你有操作 k8s全集群所有权限。在 v3 版本中删除 Tiller，直接与 k8s api 进行通信，权限管理更清晰 helm 提供 libary 模板引擎切换为 Lua 目前通过 Hook 方式创建的资源，helm 后续不会管理，在 v3 会增加管理 Hook 资源功能 目前所有配置保存在 cm 中，后续考虑保存到 secret v2 需要单独维护仓库，v3 中可以将 Chart 推送到 Docker 镜像仓库中，提供 helm push/login 功能 &mldr; Helm2 基本使用 链接到标题 安装 链接到标题 在 Helm Github Release 下载最新版本二进制文件，并在本地解压。"><meta property="og:type" content="article"><meta property="og:url" content="https://zdyxry.github.io/2019/06/21/Kubernetes-%E5%AE%9E%E6%88%98-Helm-%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-06-21T20:40:24+00:00"><meta property="article:modified_time" content="2019-06-21T20:40:24+00:00"><link rel=canonical href=https://zdyxry.github.io/2019/06/21/Kubernetes-%E5%AE%9E%E6%88%98-Helm-%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.01bd429dda63a16d76996eaf0b8da061429b76e714515cb1b246aac7fe7f4b2a.css integrity="sha256-Ab1CndpjoW12mW6vC42gYUKbducUUVyxskaqx/5/Syo=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/yiran.png sizes=32x32><link rel=icon type=image/png href=/images/yiran.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.101.0"></head><body class="preload-transitions colorscheme-dark"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Yiran's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/friends/>Friends</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://zdyxry.github.io/2019/06/21/Kubernetes-%E5%AE%9E%E6%88%98-Helm-%E5%8C%85%E7%AE%A1%E7%90%86%E5%99%A8/>Kubernetes 实战-Helm 包管理器</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-06-21T20:40:24Z>June 21, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
阅读时间：10 分钟</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/Kubernetes/>Kubernetes</a></span></div></div></header><nav id=TableOfContents><ul><li><a href=#简介>简介</a><ul><li><a href=#基本概念>基本概念</a></li><li><a href=#现状>现状</a></li></ul></li><li><a href=#helm2-基本使用>Helm2 基本使用</a><ul><li><a href=#安装>安装</a></li><li><a href=#基本使用>基本使用</a></li></ul></li><li><a href=#总结>总结</a></li></ul></nav><div class=post-content><h2 id=简介>简介
<a class=heading-link href=#%e7%ae%80%e4%bb%8b><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>Helm 就是<code>k8s 的包管理器</code> 。常见的包管理器有：yum,apt,pip&mldr;</p><p>包管理器基础功能有：</p><ul><li>安装<ul><li>依赖安装</li></ul></li><li>升级</li><li>回滚</li><li>卸载</li><li>源管理</li><li>搜索</li><li>&mldr;</li></ul><h3 id=基本概念>基本概念
<a class=heading-link href=#%e5%9f%ba%e6%9c%ac%e6%a6%82%e5%bf%b5><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><ul><li><p>Helm: Kubernetes的包管理工具，命令行同名</p></li><li><p>Tiller: Helmv2 的服务端，用于接收并处理 Helm 发送的请求，默认以 Deployment 形式部署在 k8s 集群中</p></li><li><p>Chart: Helm 包管理的基础单元，等同于 RPM</p></li><li><p>Repoistory: Helm的软件源仓库，是一个 Web 服务器，路径下除了响应的软件 Chart 包之外，维护了一个 index.yaml 用于索引</p></li><li><p>Release: Helm 安装在 Kubernetes 集群中的 Chart 实例</p></li></ul><h3 id=现状>现状
<a class=heading-link href=#%e7%8e%b0%e7%8a%b6><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>helm 截至06月20日最新稳定版本为 v2.14.1。</p><p>在05月16日发布了 v3.0 alpha 版本，根据相关文档描述，v2 无法平滑升级到 v3 版本。</p><p>注：存在部分小版本无法平滑升级情况。</p><p>helm v3 版本改进：</p><ol><li>在 v2 版本设计中，需要单独创建属于 Tiller 的 ServiceAccount，授权 clusteradmin 权限，以为着只要你有 helm 权限，那么你有操作 k8s全集群所有权限。在 v3 版本中删除 Tiller，直接与 k8s api 进行通信，权限管理更清晰</li><li>helm 提供 libary</li><li>模板引擎切换为 Lua</li><li>目前通过 Hook 方式创建的资源，helm 后续不会管理，在 v3 会增加管理 Hook 资源功能</li><li>目前所有配置保存在 cm 中，后续考虑保存到 secret</li><li>v2 需要单独维护仓库，v3 中可以将 Chart 推送到 Docker 镜像仓库中，提供 helm push/login 功能</li><li>&mldr;</li></ol><h2 id=helm2-基本使用>Helm2 基本使用
<a class=heading-link href=#helm2-%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><h3 id=安装>安装
<a class=heading-link href=#%e5%ae%89%e8%a3%85><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>在 Helm Github <a href=https://github.com/helm/helm/releases>Release</a> 下载最新版本二进制文件，并在本地解压。</p><p>在 k8s master 节点，执行 <code>helm init --server-account tiller</code> 将 Tiller 部署在 k8s 集群中，指定 Service Account 为 Tiller。</p><p>在 k8s 1.6 版本之后，需要创建对应的 ServiceAccount 资源给 Tiller ，便于 Tiller 后续创建资源，参考官方文档：</p><p>rbac-config.yaml</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=font-weight:700>apiVersion</span>: v1
</span></span><span style=display:flex><span><span style=font-weight:700>kind</span>: ServiceAccount
</span></span><span style=display:flex><span><span style=font-weight:700>metadata</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>name</span>: tiller
</span></span><span style=display:flex><span>  <span style=font-weight:700>namespace</span>: kube-system
</span></span><span style=display:flex><span><span style=font-weight:700>---</span>
</span></span><span style=display:flex><span><span style=font-weight:700>apiVersion</span>: rbac.authorization.k8s.io/v1
</span></span><span style=display:flex><span><span style=font-weight:700>kind</span>: ClusterRoleBinding
</span></span><span style=display:flex><span><span style=font-weight:700>metadata</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>name</span>: tiller
</span></span><span style=display:flex><span><span style=font-weight:700>roleRef</span>:
</span></span><span style=display:flex><span>  <span style=font-weight:700>apiGroup</span>: rbac.authorization.k8s.io
</span></span><span style=display:flex><span>  <span style=font-weight:700>kind</span>: ClusterRole
</span></span><span style=display:flex><span>  <span style=font-weight:700>name</span>: cluster-admin
</span></span><span style=display:flex><span><span style=font-weight:700>subjects</span>:
</span></span><span style=display:flex><span>  - <span style=font-weight:700>kind</span>: ServiceAccount
</span></span><span style=display:flex><span>    <span style=font-weight:700>name</span>: tiller
</span></span><span style=display:flex><span>    <span style=font-weight:700>namespace</span>: kube-system
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl create -f rbac-config.yaml
</span></span><span style=display:flex><span>serviceaccount <span style=font-style:italic>&#34;tiller&#34;</span> created
</span></span><span style=display:flex><span>clusterrolebinding <span style=font-style:italic>&#34;tiller&#34;</span> created
</span></span></code></pre></div><p>通过 <code>helm version</code> 验证是否部署成功，成功会显示 client 和 server 对应版本。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm version</span>
</span></span><span style=display:flex><span>Client: &amp;version.Version{SemVer:<span style=font-style:italic>&#34;v2.14.1&#34;</span>, GitCommit:<span style=font-style:italic>&#34;5270352a09c7e8b6e8c9593002a73535276507c0&#34;</span>, GitTreeState:<span style=font-style:italic>&#34;clean&#34;</span>}
</span></span><span style=display:flex><span>Server: &amp;version.Version{SemVer:<span style=font-style:italic>&#34;v2.14.1&#34;</span>, GitCommit:<span style=font-style:italic>&#34;5270352a09c7e8b6e8c9593002a73535276507c0&#34;</span>, GitTreeState:<span style=font-style:italic>&#34;clean&#34;</span>}
</span></span></code></pre></div><h3 id=基本使用>基本使用
<a class=heading-link href=#%e5%9f%ba%e6%9c%ac%e4%bd%bf%e7%94%a8><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><h4 id=chart构建>Chart构建
<a class=heading-link href=#chart%e6%9e%84%e5%bb%ba><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>本地创建一个测试软件包：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm create yiran-test</span>
</span></span><span style=display:flex><span>Creating yiran-test
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># tree yiran-test/</span>
</span></span><span style=display:flex><span>yiran-test/
</span></span><span style=display:flex><span>├── charts                            <span style=font-style:italic># yiran-test 所依赖的 Chart，此处为空</span>
</span></span><span style=display:flex><span>├── Chart.yaml                        <span style=font-style:italic># yiran-test 的基本信息，包含：名称，apiversion, appversion, version</span>
</span></span><span style=display:flex><span>├── templates
</span></span><span style=display:flex><span>│   ├── deployment.yaml               <span style=font-style:italic># 配置模板路径</span>
</span></span><span style=display:flex><span>│   ├── _helpers.tpl                  <span style=font-style:italic># 用于修改kubernetes objcet配置的模板</span>
</span></span><span style=display:flex><span>│   ├── ingress.yaml                  <span style=font-style:italic># </span>
</span></span><span style=display:flex><span>│   ├── NOTES.txt                     <span style=font-style:italic># 类似于 Chart README</span>
</span></span><span style=display:flex><span>│   ├── service.yaml                  <span style=font-style:italic># </span>
</span></span><span style=display:flex><span>│   └── tests
</span></span><span style=display:flex><span>│       └── test-connection.yaml      <span style=font-style:italic># 测试模板</span>
</span></span><span style=display:flex><span>└── values.yaml                       <span style=font-style:italic># 用于渲染模板的具体值</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3 directories, 8 files
</span></span></code></pre></div><p>有了基础示例，我们可以先通过 <code>dry-run</code> 方式跑一下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm install --dry-run --debug ./</span>
</span></span><span style=display:flex><span>[debug] Created tunnel using local port: <span style=font-style:italic>&#39;39257&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[debug] SERVER: <span style=font-style:italic>&#34;127.0.0.1:39257&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[debug] Original chart version: <span style=font-style:italic>&#34;&#34;</span>
</span></span><span style=display:flex><span>[debug] CHART PATH: /root/helm/yiran-test
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME:   torrid-rodent
</span></span><span style=display:flex><span>REVISION: 1
</span></span><span style=display:flex><span>RELEASED: Thu Jun 20 19:10:08 2019
</span></span><span style=display:flex><span>CHART: yiran-test-0.1.0
</span></span><span style=display:flex><span>USER-SUPPLIED VALUES:
</span></span><span style=display:flex><span>{}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>COMPUTED VALUES:
</span></span><span style=display:flex><span>affinity: {}
</span></span><span style=display:flex><span>fullnameOverride: <span style=font-style:italic>&#34;&#34;</span>
</span></span><span style=display:flex><span>image:
</span></span><span style=display:flex><span>  pullPolicy: IfNotPresent
</span></span><span style=display:flex><span>  repository: nginx
</span></span><span style=display:flex><span>  tag: stable
</span></span><span style=display:flex><span>imagePullSecrets: []
</span></span><span style=display:flex><span>ingress:
</span></span><span style=display:flex><span>  annotations: {}
</span></span><span style=display:flex><span>  enabled: false
</span></span><span style=display:flex><span>  hosts:
</span></span><span style=display:flex><span>  - host: chart-example.local
</span></span><span style=display:flex><span>    paths: []
</span></span><span style=display:flex><span>  tls: []
</span></span><span style=display:flex><span>nameOverride: <span style=font-style:italic>&#34;&#34;</span>
</span></span><span style=display:flex><span>nodeSelector: {}
</span></span><span style=display:flex><span>replicaCount: 1
</span></span><span style=display:flex><span>resources: {}
</span></span><span style=display:flex><span>service:
</span></span><span style=display:flex><span>  port: 80
</span></span><span style=display:flex><span>  type: ClusterIP
</span></span><span style=display:flex><span>tolerations: []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HOOKS:
</span></span><span style=display:flex><span>---
</span></span><span style=display:flex><span><span style=font-style:italic># torrid-rodent-yiran-test-test-connection</span>
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>kind: Pod
</span></span><span style=display:flex><span>metadata:
</span></span><span style=display:flex><span>  name: <span style=font-style:italic>&#34;torrid-rodent-yiran-test-test-connection&#34;</span>
</span></span><span style=display:flex><span>  labels:
</span></span><span style=display:flex><span>    app.kubernetes.io/name: yiran-test
</span></span><span style=display:flex><span>    helm.sh/chart: yiran-test-0.1.0
</span></span><span style=display:flex><span>    app.kubernetes.io/instance: torrid-rodent
</span></span><span style=display:flex><span>    app.kubernetes.io/version: <span style=font-style:italic>&#34;1.0&#34;</span>
</span></span><span style=display:flex><span>    app.kubernetes.io/managed-by: Tiller
</span></span><span style=display:flex><span>  annotations:
</span></span><span style=display:flex><span>    <span style=font-style:italic>&#34;helm.sh/hook&#34;</span>: test-success
</span></span><span style=display:flex><span>spec:
</span></span><span style=display:flex><span>  containers:
</span></span><span style=display:flex><span>    - name: wget
</span></span><span style=display:flex><span>      image: busybox
</span></span><span style=display:flex><span>      command: [<span style=font-style:italic>&#39;wget&#39;</span>]
</span></span><span style=display:flex><span>      args:  [<span style=font-style:italic>&#39;torrid-rodent-yiran-test:80&#39;</span>]
</span></span><span style=display:flex><span>  restartPolicy: Never
</span></span><span style=display:flex><span>MANIFEST:
</span></span></code></pre></div><h4 id=安装-1>安装
<a class=heading-link href=#%e5%ae%89%e8%a3%85-1><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>可以看到生成的 YAML 文件就是拿 values.yaml 值渲染模板生成的，那么我们来安装一下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm install ./</span>
</span></span><span style=display:flex><span>NAME:   precise-bear
</span></span><span style=display:flex><span>LAST DEPLOYED: Thu Jun 20 19:12:01 2019
</span></span><span style=display:flex><span>NAMESPACE: default
</span></span><span style=display:flex><span>STATUS: DEPLOYED
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RESOURCES:
</span></span><span style=display:flex><span>==&gt; v1/Deployment
</span></span><span style=display:flex><span>NAME                     READY  UP-TO-DATE  AVAILABLE  AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test  0/1    0           0          1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Pod(related)
</span></span><span style=display:flex><span>NAME                                      READY  STATUS             RESTARTS  AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test-785f967587-9rll6  0/1    ContainerCreating  0         1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Service
</span></span><span style=display:flex><span>NAME                     TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)  AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test  ClusterIP  10.68.142.106  &lt;none&gt;       80/TCP   1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NOTES:
</span></span><span style=display:flex><span>1. Get the application URL by running these commands:
</span></span><span style=display:flex><span>  export POD_NAME=<span style=font-weight:700>$(</span>kubectl get pods --namespace default -l <span style=font-style:italic>&#34;app.kubernetes.io/name=yiran-test,app.kubernetes.io/instance=precise-bear&#34;</span> -o jsonpath=<span style=font-style:italic>&#34;{.items[0].metadata.name}&#34;</span><span style=font-weight:700>)</span>
</span></span><span style=display:flex><span>  echo <span style=font-style:italic>&#34;Visit http://127.0.0.1:8080 to use your application&#34;</span>
</span></span><span style=display:flex><span>  kubectl port-forward $POD_NAME 8080:80
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm list </span>
</span></span><span style=display:flex><span>NAME            REVISION    UPDATED                     STATUS      CHART               APP VERSION NAMESPACE
</span></span><span style=display:flex><span>precise-bear    1           Thu Jun 20 19:12:01 2019    DEPLOYED    yiran-test-0.1.0    1.0         default  
</span></span><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># kubectl get pod </span>
</span></span><span style=display:flex><span>NAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test-785f967587-9rll6   0/1     Running   0          7s
</span></span></code></pre></div><p>注意，此时我们已经创建好了对应的资源，可以通过 <code>kubectl</code> 来查看状态。</p><h4 id=升级>升级
<a class=heading-link href=#%e5%8d%87%e7%ba%a7><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>我们来修改一下 <code>yiran-test/Chart.yaml</code> ，调整下版本，进行升级：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># cat Chart.yaml</span>
</span></span><span style=display:flex><span>apiVersion: v2
</span></span><span style=display:flex><span>appVersion: <span style=font-style:italic>&#34;2.0&#34;</span>
</span></span><span style=display:flex><span>description: A Helm chart <span style=font-weight:700>for</span> Kubernetes
</span></span><span style=display:flex><span>name: yiran-test
</span></span><span style=display:flex><span>version: 0.2.0
</span></span><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm list </span>
</span></span><span style=display:flex><span>heNAME          REVISION    UPDATED                     STATUS      CHART               APP VERSION NAMESPACE
</span></span><span style=display:flex><span>precise-bear    1           Thu Jun 20 19:12:01 2019    DEPLOYED    yiran-test-0.1.0    1.0         default  
</span></span><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm upgrade precise-bear ./</span>
</span></span><span style=display:flex><span>Release <span style=font-style:italic>&#34;precise-bear&#34;</span> has been upgraded.
</span></span><span style=display:flex><span>LAST DEPLOYED: Thu Jun 20 19:18:30 2019
</span></span><span style=display:flex><span>NAMESPACE: default
</span></span><span style=display:flex><span>STATUS: DEPLOYED
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RESOURCES:
</span></span><span style=display:flex><span>==&gt; v1/Deployment
</span></span><span style=display:flex><span>NAME                     READY  UP-TO-DATE  AVAILABLE  AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test  1/1    1           1          6m30s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Pod(related)
</span></span><span style=display:flex><span>NAME                                      READY  STATUS   RESTARTS  AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test-785f967587-9rll6  1/1    Running  0         6m30s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Service
</span></span><span style=display:flex><span>NAME                     TYPE       CLUSTER-IP     EXTERNAL-IP  PORT(S)  AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test  ClusterIP  10.68.142.106  &lt;none&gt;       80/TCP   6m30s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NOTES:
</span></span><span style=display:flex><span>1. Get the application URL by running these commands:
</span></span><span style=display:flex><span>  export POD_NAME=<span style=font-weight:700>$(</span>kubectl get pods --namespace default -l <span style=font-style:italic>&#34;app.kubernetes.io/name=yiran-test,app.kubernetes.io/instance=precise-bear&#34;</span> -o jsonpath=<span style=font-style:italic>&#34;{.items[0].metadata.name}&#34;</span><span style=font-weight:700>)</span>
</span></span><span style=display:flex><span>  echo <span style=font-style:italic>&#34;Visit http://127.0.0.1:8080 to use your application&#34;</span>
</span></span><span style=display:flex><span>  kubectl port-forward $POD_NAME 8080:80
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm list </span>
</span></span><span style=display:flex><span>NAME            REVISION    UPDATED                     STATUS      CHART               APP VERSION NAMESPACE
</span></span><span style=display:flex><span>precise-bear    2           Thu Jun 20 19:18:30 2019    DEPLOYED    yiran-test-0.2.0    2.0         default  
</span></span></code></pre></div><h4 id=回滚>回滚
<a class=heading-link href=#%e5%9b%9e%e6%bb%9a><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>通过上述步骤，我们已经把我们的应用 <code>yiran-test</code> 从 <code>0.1.0</code> 版本升级到了 <code>0.2.0</code> 版本，那么我们现在来尝试下回滚。</p><p>helm 回滚操作需要指定 Release 名称和目标版本：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm list </span>
</span></span><span style=display:flex><span>NAME            REVISION    UPDATED                     STATUS      CHART               APP VERSION NAMESPACE
</span></span><span style=display:flex><span>precise-bear    2           Thu Jun 20 19:18:30 2019    DEPLOYED    yiran-test-0.2.0    2.0         default  
</span></span><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm rollback precise-bear 1</span>
</span></span><span style=display:flex><span>Rollback was a success.
</span></span><span style=display:flex><span>[root@node1 yiran-test]<span style=font-style:italic># helm list </span>
</span></span><span style=display:flex><span>NAME            REVISION    UPDATED                     STATUS      CHART               APP VERSION NAMESPACE
</span></span><span style=display:flex><span>precise-bear    3           Thu Jun 20 19:23:04 2019    DEPLOYED    yiran-test-0.1.0    1.0         default  
</span></span></code></pre></div><p>嗯，可以看到，我们指定了回滚的目标 REVISION，回滚成功了，<code>yiran-test</code> 回到了 <code>0.1.0</code> 版本，但是，最恶心的来了，Release 的当前版本变成了 <code>3</code> ，而不是设想中的 <code>1</code> 。</p><h4 id=卸载>卸载
<a class=heading-link href=#%e5%8d%b8%e8%bd%bd><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>如果我们想要从 k8s 上卸载对应的软件，也就是我们的 <code>yiran-test</code> ，我们可以直接执行 <code>delete</code> 命令，会直接把相关资源全部删除掉。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm list</span>
</span></span><span style=display:flex><span>NAME            REVISION        UPDATED                         STATUS          CHART                   APP VERSION     NAMESPACE
</span></span><span style=display:flex><span>precise-bear    3               Thu Jun 20 19:23:04 2019        DEPLOYED        yiran-test-0.1.0        1.0             default
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># kubectl get pod</span>
</span></span><span style=display:flex><span>kuNAME                                       READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test-785f967587-9rll6   1/1     Running   0          139m
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># kubectl get svc</span>
</span></span><span style=display:flex><span>NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
</span></span><span style=display:flex><span>kubernetes                ClusterIP   10.68.0.1       &lt;none&gt;        443/TCP   36d
</span></span><span style=display:flex><span>precise-bear-yiran-test   ClusterIP   10.68.142.106   &lt;none&gt;        80/TCP    139m
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm delete precise-bear</span>
</span></span><span style=display:flex><span>release <span style=font-style:italic>&#34;precise-bear&#34;</span> deleted
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm list</span>
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># kubectl get pod</span>
</span></span><span style=display:flex><span>NAME                                       READY   STATUS        RESTARTS   AGE
</span></span><span style=display:flex><span>precise-bear-yiran-test-785f967587-9rll6   0/1     Terminating   0          139m
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># kubectl get svc</span>
</span></span><span style=display:flex><span>NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE
</span></span><span style=display:flex><span>kubernetes   ClusterIP   10.68.0.1    &lt;none&gt;        443/TCP   36d
</span></span></code></pre></div><h4 id=软件源管理>软件源管理
<a class=heading-link href=#%e8%bd%af%e4%bb%b6%e6%ba%90%e7%ae%a1%e7%90%86><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>上面我们所有的操作都是针对本地包（路径），那么我们怎么才能通过网络下载别人已经构建好的软件包呢？</p><p>helm 使用 <code>repo</code> 命令来管理软件源，使用上也很简单，简单列举下相应命令实用说明：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm repo list</span>
</span></span><span style=display:flex><span>NAME    URL
</span></span><span style=display:flex><span>stable          https://kubernetes-charts.storage.googleapis.com
</span></span><span style=display:flex><span>local   http://127.0.0.1:8879/charts
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm repo add stable-mirror https://burdenbear.github.io/kube-charts-mirror/</span>
</span></span><span style=display:flex><span><span style=font-style:italic>&#34;stable-mirror&#34;</span> has been added to your repositories
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm repo add stable https://kubernetes-charts.storage.googleapis.com</span>
</span></span><span style=display:flex><span>helm repo list
</span></span><span style=display:flex><span><span style=font-style:italic>&#34;stable&#34;</span> has been added to your repositories
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm repo list</span>
</span></span><span style=display:flex><span>NAME            URL
</span></span><span style=display:flex><span>stable          https://kubernetes-charts.storage.googleapis.com
</span></span><span style=display:flex><span>local           http://127.0.0.1:8879/charts
</span></span><span style=display:flex><span>stable-mirror   https://burdenbear.github.io/kube-charts-mirror/
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm repo remove local</span>
</span></span><span style=display:flex><span><span style=font-style:italic>&#34;local&#34;</span> has been removed from your repositories
</span></span><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm repo list</span>
</span></span><span style=display:flex><span>NAME            URL
</span></span><span style=display:flex><span>stable          https://kubernetes-charts.storage.googleapis.com
</span></span><span style=display:flex><span>stable-mirror   https://burdenbear.github.io/kube-charts-mirror/
</span></span></code></pre></div><h4 id=软件搜索>软件搜索
<a class=heading-link href=#%e8%bd%af%e4%bb%b6%e6%90%9c%e7%b4%a2><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 ~]<span style=font-style:italic># helm search mongo</span>
</span></span><span style=display:flex><span>NAME                                            CHART VERSION   APP VERSION     DESCRIPTION
</span></span><span style=display:flex><span>stable-mirror/mongodb                           5.20.0          4.0.10          NoSQL document-oriented database that stores JSON-like <span style=font-weight:700>do</span>...
</span></span><span style=display:flex><span>stable-mirror/mongodb-replicaset                3.9.6           3.6             
</span></span><span style=display:flex><span>...
</span></span></code></pre></div><h4 id=打包与本地软件源构建>打包与本地软件源构建
<a class=heading-link href=#%e6%89%93%e5%8c%85%e4%b8%8e%e6%9c%ac%e5%9c%b0%e8%bd%af%e4%bb%b6%e6%ba%90%e6%9e%84%e5%bb%ba><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>Helm v2 命令支持本地创建软件源，命令关键字是 <code>helm serve</code> ，下面来演示下相关操作：</p><p>启动本地源，并指定 IP 地址和 repo 路径：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># pwd</span>
</span></span><span style=display:flex><span>/root/helm
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># ls </span>
</span></span><span style=display:flex><span>rbac-config.yaml  yiran-test
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm serve --address 192.168.27.231:8879 --repo-path /root/helm/ </span>
</span></span><span style=display:flex><span>Regenerating index. This may take a moment.
</span></span><span style=display:flex><span>Now serving you on 192.168.27.231:8879
</span></span></code></pre></div><p>新开终端，通过修改 <code>yiran-test</code> 的 Chart.yaml 文件打包两个版本的 Chart：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># cat yiran-test/Chart.yaml </span>
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>appVersion: <span style=font-style:italic>&#34;1.0&#34;</span>
</span></span><span style=display:flex><span>description: A Helm chart <span style=font-weight:700>for</span> Kubernetes
</span></span><span style=display:flex><span>name: yiran-test
</span></span><span style=display:flex><span>version: 0.1.0
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm package yiran-test</span>
</span></span><span style=display:flex><span>Successfully packaged chart and saved it to: /root/helm/yiran-test-0.1.0.tgz
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># vi yiran-test/Chart.yaml </span>
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># cat yiran-test/Chart.yaml</span>
</span></span><span style=display:flex><span>apiVersion: v2
</span></span><span style=display:flex><span>appVersion: <span style=font-style:italic>&#34;2.0&#34;</span>
</span></span><span style=display:flex><span>description: A Helm chart <span style=font-weight:700>for</span> Kubernetes
</span></span><span style=display:flex><span>name: yiran-test
</span></span><span style=display:flex><span>version: 0.2.0
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm package yiran-test</span>
</span></span><span style=display:flex><span>Successfully packaged chart and saved it to: /root/helm/yiran-test-0.2.0.tgz
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># ls </span>
</span></span><span style=display:flex><span>index.yaml  rbac-config.yaml  yiran-test  yiran-test-0.1.0.tgz  yiran-test-0.2.0.tgz
</span></span></code></pre></div><p>此时访问浏览器，应该只能看到空的列表，我们更新一下软件源索引：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm repo index --url=http://192.168.27.231:8879 .</span>
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># pwd</span>
</span></span><span style=display:flex><span>/root/helm
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># cat index.yaml </span>
</span></span><span style=display:flex><span>apiVersion: v1
</span></span><span style=display:flex><span>entries:
</span></span><span style=display:flex><span>  yiran-test:
</span></span><span style=display:flex><span>  - apiVersion: v2
</span></span><span style=display:flex><span>    appVersion: <span style=font-style:italic>&#34;2.0&#34;</span>
</span></span><span style=display:flex><span>    created: <span style=font-style:italic>&#34;2019-06-21T13:43:41.220764856+08:00&#34;</span>
</span></span><span style=display:flex><span>    description: A Helm chart <span style=font-weight:700>for</span> Kubernetes
</span></span><span style=display:flex><span>    digest: af54cfdc5f8e6463a91311496bab8fafd7364c3588b85b5e676fb930cd4e2754
</span></span><span style=display:flex><span>    name: yiran-test
</span></span><span style=display:flex><span>    urls:
</span></span><span style=display:flex><span>    - http://192.168.27.231:8879/yiran-test-0.2.0.tgz
</span></span><span style=display:flex><span>    version: 0.2.0
</span></span><span style=display:flex><span>  - apiVersion: v1
</span></span><span style=display:flex><span>    appVersion: <span style=font-style:italic>&#34;1.0&#34;</span>
</span></span><span style=display:flex><span>    created: <span style=font-style:italic>&#34;2019-06-21T13:43:41.220059406+08:00&#34;</span>
</span></span><span style=display:flex><span>    description: A Helm chart <span style=font-weight:700>for</span> Kubernetes
</span></span><span style=display:flex><span>    digest: 64b94c30827aab8e52f57cd3950645bb14ae2deb44e3100d48ecd64f1e706ea5
</span></span><span style=display:flex><span>    name: yiran-test
</span></span><span style=display:flex><span>    urls:
</span></span><span style=display:flex><span>    - http://192.168.27.231:8879/yiran-test-0.1.0.tgz
</span></span><span style=display:flex><span>    version: 0.1.0
</span></span><span style=display:flex><span>generated: <span style=font-style:italic>&#34;2019-06-21T13:43:41.218753007+08:00&#34;</span>
</span></span></code></pre></div><p>可以看到在 repo 路径下生成了一个 index.yaml 文件，这个文件就是 repo 的索引文件，我们可以直接通过浏览器访问 <code>http://192.168.27.231:8879</code> 来浏览或下载所需软件包。</p><p>也可以将本地 repo 添加到 helm 中，使用 helm 命令将软件包部署到 k8s 中：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm repo list </span>
</span></span><span style=display:flex><span>NAME         	URL                                             
</span></span><span style=display:flex><span>stable       	https://kubernetes-charts.storage.googleapis.com
</span></span><span style=display:flex><span>stable-mirror	https://burdenbear.github.io/kube-charts-mirror/
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm repo add local http://192.168.27.231:8879</span>
</span></span><span style=display:flex><span><span style=font-style:italic>&#34;local&#34;</span> has been added to your repositories
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm repo list </span>
</span></span><span style=display:flex><span>NAME         	URL                                             
</span></span><span style=display:flex><span>stable       	https://kubernetes-charts.storage.googleapis.com
</span></span><span style=display:flex><span>stable-mirror	https://burdenbear.github.io/kube-charts-mirror/
</span></span><span style=display:flex><span>local        	http://192.168.27.231:8879                      
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm search yiran</span>
</span></span><span style=display:flex><span>NAME            	CHART VERSION	APP VERSION	DESCRIPTION                
</span></span><span style=display:flex><span>local/yiran-test	0.2.0        	2.0        	A Helm chart <span style=font-weight:700>for</span> Kubernetes
</span></span></code></pre></div><p>尝试从本地源安装应用：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm list </span>
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm search yiran</span>
</span></span><span style=display:flex><span>NAME            	CHART VERSION	APP VERSION	DESCRIPTION                
</span></span><span style=display:flex><span>local/yiran-test	0.2.0        	2.0        	A Helm chart <span style=font-weight:700>for</span> Kubernetes
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm install local/yiran-test</span>
</span></span><span style=display:flex><span>NAME:   orange-chicken
</span></span><span style=display:flex><span>LAST DEPLOYED: Fri Jun 21 13:49:45 2019
</span></span><span style=display:flex><span>NAMESPACE: default
</span></span><span style=display:flex><span>STATUS: DEPLOYED
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RESOURCES:
</span></span><span style=display:flex><span>==&gt; v1/Deployment
</span></span><span style=display:flex><span>NAME                       READY  UP-TO-DATE  AVAILABLE  AGE
</span></span><span style=display:flex><span>orange-chicken-yiran-test  0/1    0           0          1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Pod(related)
</span></span><span style=display:flex><span>NAME                                        READY  STATUS             RESTARTS  AGE
</span></span><span style=display:flex><span>orange-chicken-yiran-test-7f494c67b5-q9kwp  0/1    ContainerCreating  0         1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Service
</span></span><span style=display:flex><span>NAME                       TYPE       CLUSTER-IP    EXTERNAL-IP  PORT(S)  AGE
</span></span><span style=display:flex><span>orange-chicken-yiran-test  ClusterIP  10.68.85.197  &lt;none&gt;       80/TCP   1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NOTES:
</span></span><span style=display:flex><span>1. Get the application URL by running these commands:
</span></span><span style=display:flex><span>  export POD_NAME=<span style=font-weight:700>$(</span>kubectl get pods --namespace default -l <span style=font-style:italic>&#34;app.kubernetes.io/name=yiran-test,app.kubernetes.io/instance=orange-chicken&#34;</span> -o jsonpath=<span style=font-style:italic>&#34;{.items[0].metadata.name}&#34;</span><span style=font-weight:700>)</span>
</span></span><span style=display:flex><span>  echo <span style=font-style:italic>&#34;Visit http://127.0.0.1:8080 to use your application&#34;</span>
</span></span><span style=display:flex><span>  kubectl port-forward $POD_NAME 8080:80
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm list </span>
</span></span><span style=display:flex><span>NAME          	REVISION	UPDATED                 	STATUS  	CHART           	APP VERSION	NAMESPACE
</span></span><span style=display:flex><span>orange-chicken	1       	Fri Jun 21 13:49:45 2019	DEPLOYED	yiran-test-0.2.0	2.0        	default 
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># kubectl get pod </span>
</span></span><span style=display:flex><span>NAME                                         READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>orange-chicken-yiran-test-7f494c67b5-q9kwp   1/1     Running   0          62s
</span></span></code></pre></div><h4 id=chart-依赖管理>Chart 依赖管理
<a class=heading-link href=#chart-%e4%be%9d%e8%b5%96%e7%ae%a1%e7%90%86><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>包管理器一个比较钟要的功能就是依赖管理，当我安装 A，A 依赖于 B，那么 B 应该会自动安装完成。</p><p>我们在 <code>yiran-test</code> 中添加两个依赖，并构建：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># cat yiran-test/requirements.yaml   # 添加 apache 和 mysql 依赖</span>
</span></span><span style=display:flex><span>dependencies:
</span></span><span style=display:flex><span>  - name: apache
</span></span><span style=display:flex><span>    version: 4.3.2
</span></span><span style=display:flex><span>    repository: https://charts.bitnami.com
</span></span><span style=display:flex><span>  - name: mysql
</span></span><span style=display:flex><span>    version: 1.2.0
</span></span><span style=display:flex><span>    repository: https://burdenbear.github.io/kube-charts-mirror/
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># tree yiran-test/ # 当前目录结构</span>
</span></span><span style=display:flex><span>yiran-test/
</span></span><span style=display:flex><span>├── charts
</span></span><span style=display:flex><span>├── Chart.yaml
</span></span><span style=display:flex><span>├── requirements.yaml
</span></span><span style=display:flex><span>├── templates
</span></span><span style=display:flex><span>│   ├── deployment.yaml
</span></span><span style=display:flex><span>│   ├── _helpers.tpl
</span></span><span style=display:flex><span>│   ├── ingress.yaml
</span></span><span style=display:flex><span>│   ├── NOTES.txt
</span></span><span style=display:flex><span>│   ├── service.yaml
</span></span><span style=display:flex><span>│   └── tests
</span></span><span style=display:flex><span>│       └── test-connection.yaml
</span></span><span style=display:flex><span>└── values.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3 directories, 9 files
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm dep up yiran-test/ # 下载依赖到本地</span>
</span></span><span style=display:flex><span>Hang tight <span style=font-weight:700>while</span> we grab the latest from your chart repositories...
</span></span><span style=display:flex><span>...Successfully got an update from the <span style=font-style:italic>&#34;local&#34;</span> chart repository
</span></span><span style=display:flex><span>...Successfully got an update from the <span style=font-style:italic>&#34;stable&#34;</span> chart repository
</span></span><span style=display:flex><span>...Successfully got an update from the <span style=font-style:italic>&#34;bitnami&#34;</span> chart repository
</span></span><span style=display:flex><span>...Successfully got an update from the <span style=font-style:italic>&#34;stable-mirror&#34;</span> chart repository
</span></span><span style=display:flex><span>Update Complete.
</span></span><span style=display:flex><span>Saving 2 charts
</span></span><span style=display:flex><span>Downloading apache from repo https://charts.bitnami.com
</span></span><span style=display:flex><span>Downloading mysql from repo https://burdenbear.github.io/kube-charts-mirror/
</span></span><span style=display:flex><span>Deleting outdated charts
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># tree yiran-test/ # 完整目录结构</span>
</span></span><span style=display:flex><span>yiran-test/
</span></span><span style=display:flex><span>├── charts
</span></span><span style=display:flex><span>│   ├── apache-4.3.2.tgz
</span></span><span style=display:flex><span>│   └── mysql-1.2.0.tgz
</span></span><span style=display:flex><span>├── Chart.yaml
</span></span><span style=display:flex><span>├── requirements.lock
</span></span><span style=display:flex><span>├── requirements.yaml
</span></span><span style=display:flex><span>├── templates
</span></span><span style=display:flex><span>│   ├── deployment.yaml
</span></span><span style=display:flex><span>│   ├── _helpers.tpl
</span></span><span style=display:flex><span>│   ├── ingress.yaml
</span></span><span style=display:flex><span>│   ├── NOTES.txt
</span></span><span style=display:flex><span>│   ├── service.yaml
</span></span><span style=display:flex><span>│   └── tests
</span></span><span style=display:flex><span>│       └── test-connection.yaml
</span></span><span style=display:flex><span>└── values.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3 directories, 12 files
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm package yiran-test</span>
</span></span><span style=display:flex><span>Successfully packaged chart and saved it to: /root/helm/yiran-test-0.2.0.tgz
</span></span></code></pre></div><p>可以看到 helm 对依赖的管理方式是将自己所依赖的所有 Chart，均下载到 <code>yiran-test/charts/</code> 路径下，我们打包的时候其实已经包含了所有依赖了。</p><p>再创建一个 Chart，依赖于 <code>yiran-test</code> ：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># tree nested/</span>
</span></span><span style=display:flex><span>nested/
</span></span><span style=display:flex><span>├── charts
</span></span><span style=display:flex><span>│   └── yiran-test-0.2.0.tgz
</span></span><span style=display:flex><span>├── Chart.yaml
</span></span><span style=display:flex><span>├── requirements.lock
</span></span><span style=display:flex><span>├── requirements.yaml
</span></span><span style=display:flex><span>├── templates
</span></span><span style=display:flex><span>│   ├── deployment.yaml
</span></span><span style=display:flex><span>│   ├── _helpers.tpl
</span></span><span style=display:flex><span>│   ├── ingress.yaml
</span></span><span style=display:flex><span>│   ├── NOTES.txt
</span></span><span style=display:flex><span>│   ├── service.yaml
</span></span><span style=display:flex><span>│   └── tests
</span></span><span style=display:flex><span>│       └── test-connection.yaml
</span></span><span style=display:flex><span>└── values.yaml
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>3 directories, 11 files
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># cat nested/requirements.yaml </span>
</span></span><span style=display:flex><span>dependencies:
</span></span><span style=display:flex><span>  - name: yiran-test
</span></span><span style=display:flex><span>    version: 0.2.0
</span></span><span style=display:flex><span>    repository: http://192.168.27.231:8879
</span></span></code></pre></div><p>实际安装 <code>nested</code> ，来看下安装结果：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm install nested/</span>
</span></span><span style=display:flex><span>NAME:   alliterating-gopher
</span></span><span style=display:flex><span>LAST DEPLOYED: Fri Jun 21 18:22:52 2019
</span></span><span style=display:flex><span>NAMESPACE: default
</span></span><span style=display:flex><span>STATUS: DEPLOYED
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RESOURCES:
</span></span><span style=display:flex><span>==&gt; v1/ConfigMap
</span></span><span style=display:flex><span>NAME                            DATA  AGE
</span></span><span style=display:flex><span>alliterating-gopher-mysql-test  1     1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Deployment
</span></span><span style=display:flex><span>NAME                            READY  UP-TO-DATE  AVAILABLE  AGE
</span></span><span style=display:flex><span>alliterating-gopher-nested      0/1    1           0          1s
</span></span><span style=display:flex><span>alliterating-gopher-yiran-test  0/1    1           0          1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/PersistentVolumeClaim
</span></span><span style=display:flex><span>NAME                       STATUS   VOLUME  CAPACITY  ACCESS MODES  STORAGECLASS  AGE
</span></span><span style=display:flex><span>alliterating-gopher-mysql  Pending  1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Pod(related)
</span></span><span style=display:flex><span>NAME                                             READY  STATUS             RESTARTS  AGE
</span></span><span style=display:flex><span>alliterating-gopher-apac-7bf7cc75d5-mhdsg        0/1    ContainerCreating  0         1s
</span></span><span style=display:flex><span>alliterating-gopher-mysql-5db64c59d9-987vm       0/1    Pending            0         1s
</span></span><span style=display:flex><span>alliterating-gopher-nested-6c74d785df-jdqgq      0/1    ContainerCreating  0         1s
</span></span><span style=display:flex><span>alliterating-gopher-yiran-test-67b5cb5599-nfspm  0/1    ContainerCreating  0         1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Secret
</span></span><span style=display:flex><span>NAME                       TYPE    DATA  AGE
</span></span><span style=display:flex><span>alliterating-gopher-mysql  Opaque  2     1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1/Service
</span></span><span style=display:flex><span>NAME                            TYPE          CLUSTER-IP     EXTERNAL-IP  PORT(S)                     AGE
</span></span><span style=display:flex><span>alliterating-gopher-apac        LoadBalancer  10.68.35.233   &lt;pending&gt;    80:21195/TCP,443:26200/TCP  1s
</span></span><span style=display:flex><span>alliterating-gopher-mysql       ClusterIP     10.68.70.173   &lt;none&gt;       3306/TCP                    1s
</span></span><span style=display:flex><span>alliterating-gopher-nested      ClusterIP     10.68.190.252  &lt;none&gt;       80/TCP                      1s
</span></span><span style=display:flex><span>alliterating-gopher-yiran-test  ClusterIP     10.68.217.171  &lt;none&gt;       80/TCP                      1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>==&gt; v1beta1/Deployment
</span></span><span style=display:flex><span>NAME                       READY  UP-TO-DATE  AVAILABLE  AGE
</span></span><span style=display:flex><span>alliterating-gopher-apac   0/1    1           0          1s
</span></span><span style=display:flex><span>alliterating-gopher-mysql  0/1    1           0          1s
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NOTES:
</span></span><span style=display:flex><span>1. Get the application URL by running these commands:
</span></span><span style=display:flex><span>  export POD_NAME=<span style=font-weight:700>$(</span>kubectl get pods --namespace default -l <span style=font-style:italic>&#34;app.kubernetes.io/name=nested,app.kubernetes.io/instance=alliterating-gopher&#34;</span> -o jsonpath=<span style=font-style:italic>&#34;{.items[0].metadata.name}&#34;</span><span style=font-weight:700>)</span>
</span></span><span style=display:flex><span>  echo <span style=font-style:italic>&#34;Visit http://127.0.0.1:8080 to use your application&#34;</span>
</span></span><span style=display:flex><span>  kubectl port-forward $POD_NAME 8080:80
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># helm list </span>
</span></span><span style=display:flex><span>NAME               	REVISION	UPDATED                 	STATUS  	CHART       	APP VERSION	NAMESPACE
</span></span><span style=display:flex><span>alliterating-gopher	1       	Fri Jun 21 18:22:52 2019	DEPLOYED	nested-0.1.0	1.0        	default  
</span></span><span style=display:flex><span>[root@node1 helm]<span style=font-style:italic># kubectl get pod </span>
</span></span><span style=display:flex><span>NAME                                              READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>alliterating-gopher-apac-7bf7cc75d5-mhdsg         0/1     Running   0          5s
</span></span><span style=display:flex><span>alliterating-gopher-mysql-5db64c59d9-987vm        0/1     Pending   0          5s
</span></span><span style=display:flex><span>alliterating-gopher-nested-6c74d785df-jdqgq       0/1     Running   0          5s
</span></span><span style=display:flex><span>alliterating-gopher-yiran-test-67b5cb5599-nfspm   1/1     Running   0          5s
</span></span></code></pre></div><p>我们可以看到 nested 已经安装完成了，同时 nested 依赖得 yiran-test 及 yiran-test 依赖得 mysql & apache 也已经安装了。</p><p>具体得依赖关系直接引用官方文档示例：</p><p>假设名为 “A” 的 chart 创建以下 Kubernetes 对象</p><blockquote><p>namespace &ldquo;A-Namespace&rdquo;<br>statefulset &ldquo;A-StatefulSet&rdquo;<br>service &ldquo;A-Service&rdquo;</p></blockquote><p>此外，A 依赖于创建对象的 chart B.</p><blockquote><p>namespace &ldquo;B-Namespace&rdquo;<br>replicaset &ldquo;B-ReplicaSet&rdquo;<br>service &ldquo;B-Service&rdquo;</p></blockquote><p>安装/升级 chart A 后，会创建/修改单个 Helm 版本。该版本将按以下顺序创建/更新所有上述 Kubernetes 对象：</p><blockquote><p>A-Namespace<br>B-Namespace<br>A-StatefulSet<br>B-ReplicaSet<br>A-Service<br>B-Service</p></blockquote><p>这是因为当 Helm 安装 / 升级 charts 时，charts 中的 Kubernetes 对象及其所有依赖项都是如下</p><ol><li>聚合成一个单一的集合;</li><li>按类型排序，然后按名称排序;</li><li>按该顺序创建/更新。</li></ol><p>因此，单个 release 是使用 charts 及其依赖关系创建的所有对象，这意味着 Helm 不管理依赖服务的相关启动顺序，要由上层应用自己控制（比如创建响应探针）。</p><p>具体的资源创建顺序可以看 Tiller <a href=https://github.com/helm/helm/blob/master/pkg/tiller/kind_sorter.go#L29>相关代码</a>。</p><h2 id=总结>总结
<a class=heading-link href=#%e6%80%bb%e7%bb%93><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>总体来说 Helm 基础功能使用还是很方便的，关键在于我们如何划分我们应用的粒度，比如 openstack 是以组件为粒度划分的：nova Chart 包含 api、scheduler、conductor 等服务；比如 TiDB Operator 项目是以具体功能来划分的：tidb-backup、tidb-cluster、tidb-operator 。我们应该根据自己的业务需求，合理划分。</p><p>还有一点需要注意的是，Helm 项目还处于快速发展阶段（貌似涉及 k8s 的都变化太快），尤其是最近发布了 Helm3 alpha，如果是生产系统，需要考虑后续是否能够平滑升级的影响。</p><p>如果实在不喜欢 Helm Tiller 方式，单纯使用 Helm template 也是可以的。</p></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//zdyxry.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2023
Yiran Zhou
·
技术支持 <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0433XDZ3V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G0433XDZ3V",{anonymize_ip:!1})}</script></body></html>