<!doctype html><html lang=zh-cn><head><title>Podman 初次体验 · Yiran's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yiran Zhou"><meta name=description content="背景 链接到标题 CentOS8 在9月24号正式 Release 了，比 RHEL8 要推迟了4个月。这次的更新感觉比 CentOS7 的更新要来的重要，内核更新到了4.x，网络管理彻底替换了 network.service，防火墙管理等等，还包括去除了 Docker 作为默认的容器化管理工具，使用 Podman、Buildah、Skopeo 进行了替换，这里来体验下 Podman。
容器工具体验系列：
Podman 初次体验 Buildah 初次体验 Skopeo 初次体验 本篇文章所有环境基于 CentOS8。
Podman 链接到标题 为啥不用 Docker 了？我个人觉得 Docker 目前使用上最大的问题就是需要运行一个守护进程，虽然需要 root 用户也是一个问题，但是对于我个人来说还好。随着 K8S 定义 CRI 标准，且 Docker 的稳定性一直是个问题（虽然最近有在往好的趋势发展），但越来越多人使用 CRI-O 来替代 Docker，Docker 在被大家所抛弃（- -
Podman 创建的容器不需要守护进程，且可以用普通用户创建容器。Podman 中的大部分命令的使用方式与 Docker 相同，可以看左 alias docker=podman 。
Podman 的缺点：
仅在 Linux 下支持，无法像 Docker 一样支持 Windows 和 MacOS 缺少 docker-compose 工具替代品，哪怕有 k8s Pod 概念（虽然有 podman-compose，但是他还没有release 1."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Podman 初次体验"><meta name=twitter:description content="背景 链接到标题 CentOS8 在9月24号正式 Release 了，比 RHEL8 要推迟了4个月。这次的更新感觉比 CentOS7 的更新要来的重要，内核更新到了4.x，网络管理彻底替换了 network.service，防火墙管理等等，还包括去除了 Docker 作为默认的容器化管理工具，使用 Podman、Buildah、Skopeo 进行了替换，这里来体验下 Podman。
容器工具体验系列：
Podman 初次体验 Buildah 初次体验 Skopeo 初次体验 本篇文章所有环境基于 CentOS8。
Podman 链接到标题 为啥不用 Docker 了？我个人觉得 Docker 目前使用上最大的问题就是需要运行一个守护进程，虽然需要 root 用户也是一个问题，但是对于我个人来说还好。随着 K8S 定义 CRI 标准，且 Docker 的稳定性一直是个问题（虽然最近有在往好的趋势发展），但越来越多人使用 CRI-O 来替代 Docker，Docker 在被大家所抛弃（- -
Podman 创建的容器不需要守护进程，且可以用普通用户创建容器。Podman 中的大部分命令的使用方式与 Docker 相同，可以看左 alias docker=podman 。
Podman 的缺点：
仅在 Linux 下支持，无法像 Docker 一样支持 Windows 和 MacOS 缺少 docker-compose 工具替代品，哪怕有 k8s Pod 概念（虽然有 podman-compose，但是他还没有release 1."><meta property="og:title" content="Podman 初次体验"><meta property="og:description" content="背景 链接到标题 CentOS8 在9月24号正式 Release 了，比 RHEL8 要推迟了4个月。这次的更新感觉比 CentOS7 的更新要来的重要，内核更新到了4.x，网络管理彻底替换了 network.service，防火墙管理等等，还包括去除了 Docker 作为默认的容器化管理工具，使用 Podman、Buildah、Skopeo 进行了替换，这里来体验下 Podman。
容器工具体验系列：
Podman 初次体验 Buildah 初次体验 Skopeo 初次体验 本篇文章所有环境基于 CentOS8。
Podman 链接到标题 为啥不用 Docker 了？我个人觉得 Docker 目前使用上最大的问题就是需要运行一个守护进程，虽然需要 root 用户也是一个问题，但是对于我个人来说还好。随着 K8S 定义 CRI 标准，且 Docker 的稳定性一直是个问题（虽然最近有在往好的趋势发展），但越来越多人使用 CRI-O 来替代 Docker，Docker 在被大家所抛弃（- -
Podman 创建的容器不需要守护进程，且可以用普通用户创建容器。Podman 中的大部分命令的使用方式与 Docker 相同，可以看左 alias docker=podman 。
Podman 的缺点：
仅在 Linux 下支持，无法像 Docker 一样支持 Windows 和 MacOS 缺少 docker-compose 工具替代品，哪怕有 k8s Pod 概念（虽然有 podman-compose，但是他还没有release 1."><meta property="og:type" content="article"><meta property="og:url" content="https://zdyxry.github.io/2019/10/12/Podman-%E5%88%9D%E6%AC%A1%E4%BD%93%E9%AA%8C/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-10-12T21:40:30+00:00"><meta property="article:modified_time" content="2019-10-12T21:40:30+00:00"><link rel=canonical href=https://zdyxry.github.io/2019/10/12/Podman-%E5%88%9D%E6%AC%A1%E4%BD%93%E9%AA%8C/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.a1f1da6f0baa626de1763fc8157fdea088797379b7bbeb845799f2fffd5d0c82.css integrity="sha256-ofHabwuqYm3hdj/IFX/eoIh5c3m3u+uEV5ny//1dDII=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/yiran.png sizes=32x32><link rel=icon type=image/png href=/images/yiran.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.101.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Yiran's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/friends/>Friends</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://zdyxry.github.io/2019/10/12/Podman-%E5%88%9D%E6%AC%A1%E4%BD%93%E9%AA%8C/>Podman 初次体验</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-10-12T21:40:30Z>October 12, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
阅读时间：9 分钟</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/Linux/>Linux</a></span></div></div></header><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#podman>Podman</a><ul><li><a href=#安装>安装</a></li><li><a href=#配置>配置</a></li><li><a href=#使用>使用</a></li></ul></li><li><a href=#总结>总结</a></li><li><a href=#参考链接>参考链接</a></li></ul></nav><div class=post-content><h2 id=背景>背景
<a class=heading-link href=#%e8%83%8c%e6%99%af><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>CentOS8 在9月24号正式 Release 了，比 RHEL8 要推迟了4个月。这次的更新感觉比 CentOS7 的更新要来的重要，内核更新到了4.x，网络管理彻底替换了 network.service，防火墙管理等等，还包括去除了 Docker 作为默认的容器化管理工具，使用 Podman、Buildah、Skopeo 进行了替换，这里来体验下 Podman。</p><p>容器工具体验系列：</p><ul><li><a href=https://zdyxry.github.io/2019/10/12/Podman-%E5%88%9D%E6%AC%A1%E4%BD%93%E9%AA%8C/>Podman 初次体验</a></li><li><a href=https://zdyxry.github.io/2019/10/19/Buildah-%E5%88%9D%E6%AC%A1%E4%BD%93%E9%AA%8C/>Buildah 初次体验</a></li><li><a href=https://zdyxry.github.io/2019/10/26/Skopeo-%E5%88%9D%E6%AC%A1%E4%BD%93%E9%AA%8C/>Skopeo 初次体验</a></li></ul><p>本篇文章所有环境基于 CentOS8。</p><h2 id=podman>Podman
<a class=heading-link href=#podman><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>为啥不用 Docker 了？我个人觉得 Docker 目前使用上最大的问题就是需要运行一个守护进程，虽然需要 root 用户也是一个问题，但是对于我个人来说还好。随着 K8S 定义 CRI 标准，且 Docker 的稳定性一直是个问题（虽然最近有在往好的趋势发展），但越来越多人使用 CRI-O 来替代 Docker，Docker 在被大家所抛弃（- -</p><p>Podman 创建的容器不需要守护进程，且可以用普通用户创建容器。Podman 中的大部分命令的使用方式与 Docker 相同，可以看左 <code>alias docker=podman</code> 。</p><p>Podman 的缺点：</p><ol><li>仅在 Linux 下支持，无法像 Docker 一样支持 Windows 和 MacOS</li><li>缺少 docker-compose 工具替代品，哪怕有 k8s Pod 概念（虽然有 <a href=https://github.com/containers/podman-compose>podman-compose</a>，但是他还没有release 1.0版本，使用需谨慎</li><li>更新频繁（使用这类工具是有些心累的。。</li></ol><h3 id=安装>安装
<a class=heading-link href=#%e5%ae%89%e8%a3%85><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>Podman 可以直接使用 <code>dnf</code> 继续安装，需要注意的是，在 CentOS 中 Podman 依赖于 containers-common，这里会附带很多配置信息到 <code>/etc/containers</code>，后续会用到：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo dnf install podman                      
</span></span><span style=display:flex><span>Last metadata expiration check: 0:03:31 ago on Wed 02 Oct 2019 11:57:25 AM CST.
</span></span><span style=display:flex><span>Package podman-1.0.0-2.git921f98f.module_el8.0.0+58+91b614e7.x86_64 is already installed.
</span></span><span style=display:flex><span>Dependencies resolved.
</span></span><span style=display:flex><span>Nothing to <span style=font-weight:700>do</span>.
</span></span><span style=display:flex><span>Complete!
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ dnf info podman        
</span></span><span style=display:flex><span>Installed Packages
</span></span><span style=display:flex><span>Name         : podman
</span></span><span style=display:flex><span>Version      : 1.0.0
</span></span><span style=display:flex><span>Release      : 2.git921f98f.module_el8.0.0+58+91b614e7
</span></span><span style=display:flex><span>Arch         : x86_64
</span></span><span style=display:flex><span>Size         : 37 M
</span></span><span style=display:flex><span>Source       : podman-1.0.0-2.git921f98f.module_el8.0.0+58+91b614e7.src.rpm
</span></span><span style=display:flex><span>Repo         : @System
</span></span><span style=display:flex><span>From repo    : AppStream
</span></span><span style=display:flex><span>Summary      : Manage Pods, Containers and Container Images
</span></span><span style=display:flex><span>URL          : https://github.com/containers/libpod
</span></span><span style=display:flex><span>License      : ASL 2.0
</span></span><span style=display:flex><span>Description  : Manage Pods, Containers and Container Images
</span></span><span style=display:flex><span>             : libpod provides a library <span style=font-weight:700>for</span> applications looking to use
</span></span><span style=display:flex><span>             : the Container Pod concept popularized by Kubernetes.
</span></span></code></pre></div><h3 id=配置>配置
<a class=heading-link href=#%e9%85%8d%e7%bd%ae><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>安装完成后，来看下 Podman RPM 中附带了些什么文件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ rpm -ql podman  |grep -v <span style=font-style:italic>&#39;/usr/share/man/&#39;</span>  <span style=font-style:italic># 去除 man 手册中内容</span>
</span></span><span style=display:flex><span>/etc/cni/net.d/87-podman-bridge.conflist
</span></span><span style=display:flex><span>/usr/bin/podman
</span></span><span style=display:flex><span>/usr/lib/.build-id
</span></span><span style=display:flex><span>/usr/lib/.build-id/37
</span></span><span style=display:flex><span>/usr/lib/.build-id/37/e7f04d352e5dbde603e9701baedb0b1be6bc37
</span></span><span style=display:flex><span>/usr/lib/.build-id/9a
</span></span><span style=display:flex><span>/usr/lib/.build-id/9a/2b43332ca5756f9e2a086bae9b953009ef5a37
</span></span><span style=display:flex><span>/usr/lib/systemd/system/io.podman.service
</span></span><span style=display:flex><span>/usr/lib/systemd/system/io.podman.socket
</span></span><span style=display:flex><span>/usr/lib/tmpfiles.d/podman.conf
</span></span><span style=display:flex><span>/usr/libexec/podman/conmon
</span></span><span style=display:flex><span>/usr/share/bash-completion/completions/podman
</span></span><span style=display:flex><span>/usr/share/containers/libpod.conf
</span></span><span style=display:flex><span>/usr/share/licenses/podman
</span></span><span style=display:flex><span>/usr/share/licenses/podman/LICENSE
</span></span></code></pre></div><p>可以看到只有一个配置文件是在 <code>/etc/cni</code> 路径下的，与 Bridge 的配置有关：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ cat /etc/cni/net.d/87-podman-bridge.conflist
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-style:italic>&#34;cniVersion&#34;</span>: <span style=font-style:italic>&#34;0.3.0&#34;</span>,
</span></span><span style=display:flex><span>    <span style=font-style:italic>&#34;name&#34;</span>: <span style=font-style:italic>&#34;podman&#34;</span>,
</span></span><span style=display:flex><span>    <span style=font-style:italic>&#34;plugins&#34;</span>: [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;type&#34;</span>: <span style=font-style:italic>&#34;bridge&#34;</span>,
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;bridge&#34;</span>: <span style=font-style:italic>&#34;cni0&#34;</span>,
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;isGateway&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;ipMasq&#34;</span>: true,
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;ipam&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=font-style:italic>&#34;type&#34;</span>: <span style=font-style:italic>&#34;host-local&#34;</span>,
</span></span><span style=display:flex><span>            <span style=font-style:italic>&#34;subnet&#34;</span>: <span style=font-style:italic>&#34;10.88.0.0/16&#34;</span>,
</span></span><span style=display:flex><span>            <span style=font-style:italic>&#34;routes&#34;</span>: [
</span></span><span style=display:flex><span>                { <span style=font-style:italic>&#34;dst&#34;</span>: <span style=font-style:italic>&#34;0.0.0.0/0&#34;</span> }
</span></span><span style=display:flex><span>            ]
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;type&#34;</span>: <span style=font-style:italic>&#34;portmap&#34;</span>,
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;capabilities&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=font-style:italic>&#34;portMappings&#34;</span>: true
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在上面我们有提到，Podman 依赖的 containers-common RPM 中包含了很多配置文件，我们一个一个的来看一下：</p><h4 id=registriesconf>registries.conf
<a class=heading-link href=#registriesconf><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p>/etc/containers/registries.conf 用于保存 registries 相关配置：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ cat /etc/containers/registries.conf         
</span></span><span style=display:flex><span><span style=font-style:italic># This is a system-wide configuration file used to</span>
</span></span><span style=display:flex><span><span style=font-style:italic># keep track of registries for various container backends.</span>
</span></span><span style=display:flex><span><span style=font-style:italic># It adheres to TOML format and does not support recursive</span>
</span></span><span style=display:flex><span><span style=font-style:italic># lists of registries.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic># The default location for this configuration file is /etc/containers/registries.conf.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic># The only valid categories are: &#39;registries.search&#39;, &#39;registries.insecure&#39;, </span>
</span></span><span style=display:flex><span><span style=font-style:italic># and &#39;registries.block&#39;.</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[registries.search]
</span></span><span style=display:flex><span>registries = [<span style=font-style:italic>&#39;registry.redhat.io&#39;</span>, <span style=font-style:italic>&#39;quay.io&#39;</span>, <span style=font-style:italic>&#39;docker.io&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic># If you need to access insecure registries, add the registry&#39;s fully-qualified name.</span>
</span></span><span style=display:flex><span><span style=font-style:italic># An insecure registry is one that does not have a valid SSL certificate or only does HTTP.</span>
</span></span><span style=display:flex><span>[registries.insecure]
</span></span><span style=display:flex><span>registries = []
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-style:italic># If you need to block pull access from a registry, uncomment the section below</span>
</span></span><span style=display:flex><span><span style=font-style:italic># and add the registries fully-qualified name.</span>
</span></span><span style=display:flex><span><span style=font-style:italic>#</span>
</span></span><span style=display:flex><span><span style=font-style:italic># Docker only</span>
</span></span><span style=display:flex><span>[registries.block]
</span></span><span style=display:flex><span>registries = []
</span></span></code></pre></div><h4 id=mountsconf>mounts.conf
<a class=heading-link href=#mountsconf><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p><code>/usr/share/containers/mounts.conf</code> 在执行 <code>podman run</code> 或者 <code>podman build</code> 命令时自动挂载的路径，该路径只会在容器运行时挂载，不会提交到容器镜像中。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ cat /usr/share/containers/mounts.conf                               
</span></span><span style=display:flex><span>/usr/share/rhel/secrets:/run/secrets
</span></span></code></pre></div><h4 id=seccompjson>seccomp.json
<a class=heading-link href=#seccompjson><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p><code>/usr/share/containers/seccomp.json</code> 是容器内允许的 seccomp 规则白名单。 seccomp（secure computing）是一种安全保护机制，一般情况下，程序可以使用所有的 syscall，但是为了避免安全问题发生，通常会指定相应的规则来保证。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ cat /usr/share/containers/seccomp.json
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=font-style:italic>&#34;defaultAction&#34;</span>: <span style=font-style:italic>&#34;SCMP_ACT_ERRNO&#34;</span>,
</span></span><span style=display:flex><span>	<span style=font-style:italic>&#34;archMap&#34;</span>: [...],
</span></span><span style=display:flex><span>	<span style=font-style:italic>&#34;syscalls&#34;</span>: [...]
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=policyjson>policy.json
<a class=heading-link href=#policyjson><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><p><code>/etc/containers/policy.json</code> 证书安全相关配置：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ cat /etc/containers/policy.json      
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=font-style:italic>&#34;default&#34;</span>: [
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=font-style:italic>&#34;type&#34;</span>: <span style=font-style:italic>&#34;insecureAcceptAnything&#34;</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=font-style:italic>&#34;transports&#34;</span>:
</span></span><span style=display:flex><span>        {
</span></span><span style=display:flex><span>            <span style=font-style:italic>&#34;docker-daemon&#34;</span>:
</span></span><span style=display:flex><span>                {
</span></span><span style=display:flex><span>                    <span style=font-style:italic>&#34;&#34;</span>: [{<span style=font-style:italic>&#34;type&#34;</span>:<span style=font-style:italic>&#34;insecureAcceptAnything&#34;</span>}]
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=使用>使用
<a class=heading-link href=#%e4%bd%bf%e7%94%a8><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><h4 id=镜像>镜像
<a class=heading-link href=#%e9%95%9c%e5%83%8f><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><h5 id=构建>构建
<a class=heading-link href=#%e6%9e%84%e5%bb%ba><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~/podman/hello 
</span></span><span style=display:flex><span> $ pwd                                                                                                                                  1 ↵
</span></span><span style=display:flex><span>/home/yiran/podman/hello
</span></span><span style=display:flex><span>yiran@yiran-centos8:~/podman/hello 
</span></span><span style=display:flex><span> $ cat Dockerfile 
</span></span><span style=display:flex><span>FROM docker.io/library/centos:latest
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RUN echo <span style=font-style:italic>&#39;hello&#39;</span>
</span></span><span style=display:flex><span>yiran@yiran-centos8:~/podman/hello 
</span></span><span style=display:flex><span> $ podman build -t hello:1.0 .    
</span></span><span style=display:flex><span>STEP 1: FROM docker.io/library/centos:latest
</span></span><span style=display:flex><span>STEP 2: RUN echo <span style=font-style:italic>&#39;hello&#39;</span>
</span></span><span style=display:flex><span>hello
</span></span><span style=display:flex><span>--&gt; 895ce449f0b3f1f2d8a0d2dca280cb46f4c69bb2824c93bb0e72eb49987c9050
</span></span><span style=display:flex><span>STEP 3: COMMIT hello:1.0
</span></span><span style=display:flex><span>--&gt; 618f931bc244f2eaff53d9f2bcb1df97c5ddac501088d5919450a57f995173af
</span></span><span style=display:flex><span>yiran@yiran-centos8:~/podman/hello 
</span></span><span style=display:flex><span> $ podman images               
</span></span><span style=display:flex><span>REPOSITORY                             TAG      IMAGE ID       CREATED          SIZE
</span></span><span style=display:flex><span>localhost/hello                        1.0      618f931bc244   8 seconds ago    210 MB
</span></span><span style=display:flex><span>&lt;none&gt;                                 &lt;none&gt;   895ce449f0b3   13 seconds ago   210 MB
</span></span><span style=display:flex><span>docker.io/library/nginx                latest   f949e7d76d63   2 weeks ago      130 MB
</span></span><span style=display:flex><span>docker.io/library/centos               latest   67fa590cfc1c   7 weeks ago      210 MB
</span></span><span style=display:flex><span>registry.fedoraproject.org/f27/httpd   latest   18f01f6f77ef   15 months ago    426 MB
</span></span></code></pre></div><h5 id=搜索>搜索
<a class=heading-link href=#%e6%90%9c%e7%b4%a2><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman search mongo |head -n 5
</span></span><span style=display:flex><span>INDEX       NAME                                                 DESCRIPTION                                       STARS   OFFICIAL   AUTOMATED
</span></span><span style=display:flex><span>quay.io     quay.io/hellofresh/delete-old-ahoy-mongo-dbs                                                           0                  
</span></span><span style=display:flex><span>quay.io     quay.io/ukhomeofficedigital/mongo-34                                                                   0                  
</span></span><span style=display:flex><span>quay.io     quay.io/utilitywarehouse/mongo-burs                                                                    0                  
</span></span><span style=display:flex><span>quay.io     quay.io/ukhomeofficedigital/mongo                                                                      0                
</span></span></code></pre></div><h5 id=拉取>拉取
<a class=heading-link href=#%e6%8b%89%e5%8f%96><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman image pull nginx
</span></span><span style=display:flex><span>Trying to pull registry.redhat.io/nginx:latest...Failed
</span></span><span style=display:flex><span>Trying to pull quay.io/nginx:latest...Failed
</span></span><span style=display:flex><span>Trying to pull docker.io/nginx:latest...Getting image source signatures
</span></span><span style=display:flex><span>Copying blob b8f262c62ec6: 25.84 MiB / 25.84 MiB [=========================] 13s
</span></span><span style=display:flex><span>Copying blob e9218e8f93b1: 22.48 MiB / 22.48 MiB [=========================] 13s
</span></span><span style=display:flex><span>Copying blob 7acba7289aa3: 202 B / 202 B [=================================] 13s
</span></span><span style=display:flex><span>Copying config f949e7d76d63: 6.51 KiB / 6.51 KiB [==========================] 0s
</span></span><span style=display:flex><span>Writing manifest to image destination
</span></span><span style=display:flex><span>Storing signatures
</span></span><span style=display:flex><span>f949e7d76d63befffc8eec2cbf8a6f509780f96fb3bacbdc24068d594a77f043
</span></span></code></pre></div><p>除了像 Docker 一样从网络拉取镜像，Podman 为了方便用户从 Docker 迁移过来，Podman 支持从本地的 docker daemon 中直接拉取镜像，如果没有 domain 的话，目前会自动补全 <code>docker.io/library/</code> 前缀。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ docker images |grep yiran
</span></span><span style=display:flex><span>harbor.yiran.com/yiran_tuna/leader-elector                                   0.5                           129c97fdb20d        3 years ago         169MB
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman pull docker-daemon:harbor.yiran.com/yiran_tuna/leader-elector:0.5
</span></span><span style=display:flex><span>Getting image source signatures
</span></span><span style=display:flex><span>Copying blob bf87964bccfd <span style=font-weight:700>done</span>
</span></span><span style=display:flex><span>Copying blob 5f70bf18a086 <span style=font-weight:700>done</span>
</span></span><span style=display:flex><span>Copying blob 3efb68385a82 <span style=font-weight:700>done</span>
</span></span><span style=display:flex><span>Copying blob 5f70bf18a086 <span style=font-weight:700>done</span>
</span></span><span style=display:flex><span>Copying blob 42755cf4ee95 <span style=font-weight:700>done</span>
</span></span><span style=display:flex><span>Copying blob ce31f2e01592 <span style=font-weight:700>done</span>
</span></span><span style=display:flex><span>Copying blob 5f70bf18a086 skipped: already exists
</span></span><span style=display:flex><span>Copying config 129c97fdb2 <span style=font-weight:700>done</span>
</span></span><span style=display:flex><span>Writing manifest to image destination
</span></span><span style=display:flex><span>Storing signatures
</span></span><span style=display:flex><span>129c97fdb20d5fb7a0c569994f710c2b0d5292219f189f4f66c313f7bed9f434
</span></span></code></pre></div><p>看上去一切都很美好，但是要注意下面这种错误：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ERRO[0005] Error pulling image ref //testimg:latest: Error committing the finished image: error adding layer with blob &#34;sha256:caed8f108bf6721dc2709407ecad964c83a31c8008a6a21826aa4ab995df5502&#34;: Error processing tar file(exit status 1): there might not be enough IDs available in the namespace (requested 4000000:4000000 for /testfile): lchown /testfile: invalid argument
</span></span></code></pre></div><p>因为 Podman 可以用普通用户运行容器，平时操作时也都是普通用户，这时候我们就面临一个UID & GID 映射的问题，默认的 subuid 的上限是 65536，这个可以自己做相应的调整：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~/podman/hello 
</span></span><span style=display:flex><span> $ cat /etc/subuid
</span></span><span style=display:flex><span>yiran:100000:65536
</span></span><span style=display:flex><span>yiran@yiran-centos8:~/podman/hello 
</span></span><span style=display:flex><span> $ cat /etc/subgid
</span></span><span style=display:flex><span>yiran:100000:65536
</span></span></code></pre></div><p>不只是在镜像拉取过程中，在操作文件时，也需要关注 UID & GID 的问题，这个是之前使用 Docker 忽略的点。</p><h5 id=列出>列出
<a class=heading-link href=#%e5%88%97%e5%87%ba><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman images
</span></span><span style=display:flex><span>REPOSITORY                 TAG      IMAGE ID       CREATED       SIZE
</span></span><span style=display:flex><span>docker.io/library/nginx    latest   f949e7d76d63   7 days ago    130 MB
</span></span><span style=display:flex><span>docker.io/library/centos   latest   67fa590cfc1c   6 weeks ago   210 MB
</span></span></code></pre></div><h5 id=检查>检查
<a class=heading-link href=#%e6%a3%80%e6%9f%a5><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman image inspect docker.io/library/nginx |head -n 10
</span></span><span style=display:flex><span>[
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;Id&#34;</span>: <span style=font-style:italic>&#34;f949e7d76d63befffc8eec2cbf8a6f509780f96fb3bacbdc24068d594a77f043&#34;</span>,
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;Digest&#34;</span>: <span style=font-style:italic>&#34;sha256:066edc156bcada86155fd80ae03667cf3811c499df73815a2b76e43755ebbc76&#34;</span>,
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;RepoTags&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=font-style:italic>&#34;docker.io/library/nginx:latest&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span><span style=display:flex><span>        <span style=font-style:italic>&#34;RepoDigests&#34;</span>: [
</span></span><span style=display:flex><span>            <span style=font-style:italic>&#34;docker.io/library/nginx@sha256:066edc156bcada86155fd80ae03667cf3811c499df73815a2b76e43755ebbc76&#34;</span>
</span></span><span style=display:flex><span>        ],
</span></span></code></pre></div><h5 id=删除>删除
<a class=heading-link href=#%e5%88%a0%e9%99%a4><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman image rm docker.io/library/nginx                 
</span></span><span style=display:flex><span>f949e7d76d63befffc8eec2cbf8a6f509780f96fb3bacbdc24068d594a77f043
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman images                          
</span></span><span style=display:flex><span>REPOSITORY                 TAG      IMAGE ID       CREATED       SIZE
</span></span><span style=display:flex><span>docker.io/library/centos   latest   67fa590cfc1c   6 weeks ago   210 MB
</span></span></code></pre></div><h4 id=容器>容器
<a class=heading-link href=#%e5%ae%b9%e5%99%a8><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><h5 id=运行>运行
<a class=heading-link href=#%e8%bf%90%e8%a1%8c><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman images                             
</span></span><span style=display:flex><span>REPOSITORY                 TAG      IMAGE ID       CREATED       SIZE
</span></span><span style=display:flex><span>docker.io/library/centos   latest   67fa590cfc1c   6 weeks ago   210 MB
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman run -it docker.io/library/centos sh
</span></span><span style=display:flex><span>sh-4.2# cat /etc/centos-release
</span></span><span style=display:flex><span>CentOS Linux release 7.6.1810 (Core) 
</span></span><span style=display:flex><span>sh-4.2# exit
</span></span></code></pre></div><h5 id=停止>停止
<a class=heading-link href=#%e5%81%9c%e6%ad%a2><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman ps                                                                                               
</span></span><span style=display:flex><span>[sudo] password <span style=font-weight:700>for</span> yiran: 
</span></span><span style=display:flex><span>CONTAINER ID  IMAGE                                        COMMAND               CREATED        STATUS            PORTS                   NAMES
</span></span><span style=display:flex><span>af3d9001ad32  registry.fedoraproject.org/f27/httpd:latest  container-entrypo...  8 minutes ago  Up 8 minutes ago  0.0.0.0:8080-&gt;8080/tcp  elastic_goldwasser
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman stop af3d9001ad32
</span></span><span style=display:flex><span>af3d9001ad3211f5503742ca3cca8ddca542e27d7b9e54099c56ab7e04778503
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman ps               
</span></span><span style=display:flex><span>CONTAINER ID  IMAGE  COMMAND  CREATED  STATUS  PORTS  NAMES
</span></span></code></pre></div><h5 id=删除-1>删除
<a class=heading-link href=#%e5%88%a0%e9%99%a4-1><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman ps -a
</span></span><span style=display:flex><span>CONTAINER ID  IMAGE                                        COMMAND               CREATED        STATUS                     PORTS                   NAMES
</span></span><span style=display:flex><span>af3d9001ad32  registry.fedoraproject.org/f27/httpd:latest  container-entrypo...  8 minutes ago  Exited (0) 29 seconds ago  0.0.0.0:8080-&gt;8080/tcp  elastic_goldwasser
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman rm af3d9001ad32                                                                                       
</span></span><span style=display:flex><span>af3d9001ad3211f5503742ca3cca8ddca542e27d7b9e54099c56ab7e04778503
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman ps -a          
</span></span><span style=display:flex><span>CONTAINER ID  IMAGE  COMMAND  CREATED  STATUS  PORTS  NAMES
</span></span></code></pre></div><h5 id=checkpointrestore>checkpoint/restore
<a class=heading-link href=#checkpointrestore><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><p>Podman 提供了类似于 git 的功能，能够对 container 进行 checkpoint(commit)，并且可以 restore(checkout)，虽然 <a href=https://podman.io/blogs/2018/10/10/checkpoint-restore.html>demo 视频</a> 很美好，但是我本地想通过快照（虚拟化功能）的方式来验证，却发现因为 CRIU 的版本过低不支持该功能，等后续深度使用后再研究下这个功能的原理。</p><h5 id=健康检查>健康检查
<a class=heading-link href=#%e5%81%a5%e5%ba%b7%e6%a3%80%e6%9f%a5><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><p>Podman 1.2.0 版本提供了 healthcheck 功能，我们在运行容器时，可以通过参数 <code>--healthcheck-command</code> 来指定健康检查的方式，然后通过 <code>podman healthcheck</code> 命令来检测：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo podman run -dt --name hc1 --healthcheck-command <span style=font-style:italic>&#39;CMD-SHELL curl http://localhost || exit 1&#39;</span> --healthcheck-interval=0 quay.io/libpod/alpine_nginx:latest
</span></span><span style=display:flex><span>d25ee6faaf6e5e12c09e734b1ac675385fe4d4e8b52504dd01a60e1b726e3edb
</span></span><span style=display:flex><span>$ sudo podman healthcheck run hc1
</span></span><span style=display:flex><span>Healthy
</span></span><span style=display:flex><span>$ echo $?
</span></span><span style=display:flex><span>0
</span></span></code></pre></div><p><code>--healthcheck-command</code> 命令是在容器内执行的，所以我们需要保证容器镜像中存在相应命令； <code>--healthcheck-interval</code> 如果设置为 0 则不自动检查。</p><h5 id=systemd>systemd
<a class=heading-link href=#systemd><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><p>由于 Podman 没有 daemon ，所以没办法像 docker 一样通过指定参数 <code>--restart=always</code> 在 docker 进程启动时自动拉起镜像。 Podman 通过 systemd 来支持该功能。</p><p>首先，我们需要准备一个已经可以正常运行的容器：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ podman ps 
</span></span><span style=display:flex><span>CONTAINER ID  IMAGE                                  COMMAND               CREATED                 STATUS                     PORTS  NAMES
</span></span><span style=display:flex><span>cf6b656d4ab0  docker.io/library/envoy:latest  /usr/bin/mongod -...  Less than a second ago  Up Less than a second ago         smtx-mongodb
</span></span></code></pre></div><p>编写 systemd 配置文件，通常默认路径为： /usr/lib/systemd/system/</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ cat /usr/lib/systemd/system/envoy.service 
</span></span><span style=display:flex><span>[Unit]
</span></span><span style=display:flex><span>After=network.target
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Service]
</span></span><span style=display:flex><span>Restart=always
</span></span><span style=display:flex><span>ExecStart=/usr/bin/podman start -a envoy
</span></span><span style=display:flex><span>ExecStop=/usr/bin/podman stop -t 10 envoy
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>[Install]
</span></span><span style=display:flex><span>WantedBy=multi-user.target
</span></span></code></pre></div><p>编写完成后，我们需要执行下 <code>systemctl daemon-reload</code> 重新加载一次配置，然后就可以通过 <code>systemctl</code> 来控制容器的启停、开机自启动了。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ systemctl start envoy
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ systemctl enable envoy
</span></span><span style=display:flex><span>Created symlink from /etc/systemd/system/multi-user.target.wants/envoy.service to /usr/lib/systemd/system/envoy.service.
</span></span><span style=display:flex><span>[root@node99 16:28:12 ~]$systemctl status envoy
</span></span><span style=display:flex><span>● envoy.service
</span></span><span style=display:flex><span>   Loaded: loaded (/usr/lib/systemd/system/envoy.service; enabled; vendor preset: disabled)
</span></span><span style=display:flex><span>  Drop-In: /etc/systemd/system/envoy.service.d
</span></span><span style=display:flex><span>           └─cgroup.conf
</span></span><span style=display:flex><span>   Active: active (running) since Sat 2019-10-12 20:09:34 CST; 3h 41min left
</span></span><span style=display:flex><span> Main PID: 47684 (podman)
</span></span><span style=display:flex><span>   CGroup: /system.slice/system-zbs.slice/system-zbs-others.slice/envoy.service
</span></span><span style=display:flex><span>           └─47684 /usr/bin/podman start -a envoy
</span></span></code></pre></div><h4 id=pod>Pod
<a class=heading-link href=#pod><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h4><h5 id=创建及使用>创建及使用
<a class=heading-link href=#%e5%88%9b%e5%bb%ba%e5%8f%8a%e4%bd%bf%e7%94%a8><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><p>Podman 除了像 Docker 一样提供基本的容器管理，还提供了 K8S 中的 Pod 功能（得对的起名字啊）。
对于最终要运行在 k8s 环境的同学来说，Podman 非常适合，可以很大的减少环境不通导致的工作量：Podman 的 YAML 和 k8s pod yaml 文件格式是兼容的。</p><p>首先，我们来创建一个 Pod：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod create --name postgresql -p 5432 -p 9187
</span></span><span style=display:flex><span>error adding Infra Container: unable to pull k8s.gcr.io/pause:3.1: unable to pull image: Error determining manifest MIME type <span style=font-weight:700>for</span> docker://k8s.gcr.io/pause:3.1: pinging docker registry returned: Get https://k8s.gcr.io/v2/: dial tcp 64.233.189.82:443: i/o timeout
</span></span></code></pre></div><p>了解 K8S Pod 的同学应该知道 <code>google_containers/pause</code>容器，它主要的作用是 namespace 控制和启动 init 进程，即 PID 为1。在 Podman 中也是如此，这里需要 pull pause 镜像，但是喜闻乐见的 timeout。。。。</p><p>（此处开始折腾网络）</p><p>我们重新来走一次 demo ：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod create --name postgresql -p 5432 -p 9187  <span style=font-style:italic># 创建 Pod，并映射端口</span>
</span></span><span style=display:flex><span>17020cd16ae689f5d4e0f17468c67c3f9d3b8aa424d9e463dc8b187bb80bd328
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod ls                                      
</span></span><span style=display:flex><span>POD ID         NAME         STATUS    CREATED         <span style=font-style:italic># OF CONTAINERS   INFRA ID</span>
</span></span><span style=display:flex><span>17020cd16ae6   postgresql   Running   7 seconds ago   1                 5f38e2d70484
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod ps 
</span></span><span style=display:flex><span>POD ID         NAME         STATUS    CREATED          <span style=font-style:italic># OF CONTAINERS   INFRA ID</span>
</span></span><span style=display:flex><span>17020cd16ae6   postgresql   Running   23 seconds ago   1                 5f38e2d70484
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman run -d --pod postgresql -e POSTGRES_PASSWORD=password postgres:latest <span style=font-style:italic># 运行 postgresql</span>
</span></span><span style=display:flex><span>bb00b1087b3e86f5f8915deb9a826875f4a1f063b30ef6eb743c3ad6b155a823
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman run -d --pod postgresql -e DATA_SOURCE_NAME=<span style=font-style:italic>&#34;postgresql://postgres:password@localhost:5432/postgres?sslmode=disable&#34;</span>  wrouesnel/postgres_exporter <span style=font-style:italic># 运行 postgres exporter</span>
</span></span><span style=display:flex><span>f1197be2aa8be6169e0a0cf3b235b951dafdc4e98afe6753c661a9871038c17c
</span></span></code></pre></div><p>首先我们创建了一个 Pod，端口映射是在 Pod 这个级别配置的，然后在这个 Pod 中，我们创建了两个 container，分别是：postgres 和 postgres_exporter ，其中 postgres_exporter 主要是暴露 metrics 用于 Prometheus 抓取进行监控。</p><p>我们可以通过 curl 相应端口来验证是否正常工作：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>iran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman ps -a              
</span></span><span style=display:flex><span>CONTAINER ID  IMAGE                                                          COMMAND               CREATED        STATUS            PORTS                                           NAMES
</span></span><span style=display:flex><span>f1197be2aa8b  docker.io/wrouesnel/postgres_exporter:latest                   /postgres_exporte...  4 minutes ago  Up 4 minutes ago                                                  quizzical_mcclintock
</span></span><span style=display:flex><span>bb00b1087b3e  docker.io/library/postgres:latest                              docker-entrypoint...  4 minutes ago  Up 4 minutes ago                                                  kind_spence
</span></span><span style=display:flex><span>5f38e2d70484  registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.1                        5 minutes ago  Up 5 minutes ago  0.0.0.0:5432-&gt;5432/tcp, 0.0.0.0:9187-&gt;9187/tcp  17020cd16ae6-infra
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ curl localhost:9187/metrics                                                                                                                                 
</span></span><span style=display:flex><span><span style=font-style:italic># HELP go_gc_duration_seconds A summary of the GC invocation durations.</span>
</span></span><span style=display:flex><span><span style=font-style:italic># TYPE go_gc_duration_seconds summary</span>
</span></span><span style=display:flex><span>go_gc_duration_seconds{quantile=<span style=font-style:italic>&#34;0&#34;</span>} 0
</span></span><span style=display:flex><span>go_gc_duration_seconds{quantile=<span style=font-style:italic>&#34;0.25&#34;</span>} 0
</span></span><span style=display:flex><span>go_gc_duration_seconds{quantile=<span style=font-style:italic>&#34;0.5&#34;</span>} 0
</span></span><span style=display:flex><span>go_gc_duration_seconds{quantile=<span style=font-style:italic>&#34;0.75&#34;</span>} 0
</span></span><span style=display:flex><span>go_gc_duration_seconds{quantile=<span style=font-style:italic>&#34;1&#34;</span>} 0
</span></span><span style=display:flex><span>go_gc_duration_seconds_sum 0
</span></span></code></pre></div><p>可以看到已经正确的获取到了相应 metrics 数值，可以通过 <code>podman pod top</code> 来获取当前进程状态：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod top postgresql             
</span></span><span style=display:flex><span>USER                PID   PPID   %CPU    ELAPSED           TTY   TIME   COMMAND
</span></span><span style=display:flex><span>0                   1     0      0.000   6m15.74147022s    ?     0s     /pause 
</span></span><span style=display:flex><span>postgres            1     0      0.000   5m45.755275073s   ?     0s     postgres 
</span></span><span style=display:flex><span>postgres            51    1      0.000   5m44.755304824s   ?     0s     postgres: checkpointer    
</span></span><span style=display:flex><span>postgres            52    1      0.000   5m44.755329093s   ?     0s     postgres: background writer    
</span></span><span style=display:flex><span>postgres            53    1      0.000   5m44.755350888s   ?     0s     postgres: walwriter    
</span></span><span style=display:flex><span>postgres            54    1      0.000   5m44.75537351s    ?     0s     postgres: logical replication launcher    
</span></span><span style=display:flex><span>postgres_exporter   1     0      0.000   5m34.767207535s   ?     0s     /postgres_exporter 
</span></span></code></pre></div><p>在 Podman 中，可以简单的将 Pod 理解为 docker-compose 中的一组容器，并且可以通过 <code>podman pod start/stop</code> 来控制这组容器的启停：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod stop postgresql                                                                      
</span></span><span style=display:flex><span>17020cd16ae689f5d4e0f17468c67c3f9d3b8aa424d9e463dc8b187bb80bd328
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod ls              
</span></span><span style=display:flex><span>POD ID         NAME         STATUS   CREATED         <span style=font-style:italic># OF CONTAINERS   INFRA ID</span>
</span></span><span style=display:flex><span>17020cd16ae6   postgresql   Exited   8 minutes ago   3                 5f38e2d70484
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod ps 
</span></span><span style=display:flex><span>POD ID         NAME         STATUS   CREATED         <span style=font-style:italic># OF CONTAINERS   INFRA ID</span>
</span></span><span style=display:flex><span>17020cd16ae6   postgresql   Exited   8 minutes ago   3                 5f38e2d70484
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ curl localhost:9187/metrics
</span></span><span style=display:flex><span>curl: (7) Failed to connect to localhost port 9187: Connection refused
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman pod start postgresql                                                                                                                                                                            7 ↵
</span></span><span style=display:flex><span>17020cd16ae689f5d4e0f17468c67c3f9d3b8aa424d9e463dc8b187bb80bd328
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ curl localhost:9187/metrics      
</span></span><span style=display:flex><span><span style=font-style:italic># HELP go_gc_duration_seconds A summary of the GC invocation durations.</span>
</span></span><span style=display:flex><span><span style=font-style:italic># TYPE go_gc_duration_seconds summary</span>
</span></span><span style=display:flex><span>go_gc_duration_seconds{quantile=<span style=font-style:italic>&#34;0&#34;</span>} 0
</span></span><span style=display:flex><span>go_gc_duration_seconds{quantile=<span style=font-style:italic>&#34;0.25&#34;</span>} 0
</span></span><span style=display:flex><span>go_gc_duration_seconds{quantile=<span style=font-style:italic>&#34;0.5&#34;</span>} 0
</span></span></code></pre></div><h5 id=k8s-联动>k8s 联动
<a class=heading-link href=#k8s-%e8%81%94%e5%8a%a8><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h5><p>通过 <code>podman generate</code> 命令可以生成 k8s 可用的 YAML 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>020cd16ae689f5d4e0f17468c67c3f9d3b8aa424d9e463dc8b187bb80bd328
</span></span><span style=display:flex><span>yiran@yiran-centos8:~ 
</span></span><span style=display:flex><span> $ sudo podman generate kube postgresql &gt; postgresql.yaml
</span></span><span style=display:flex><span>no matching entries in passwd file
</span></span></code></pre></div><p>嗯，又遇到了一个错误，在 Github 上有看到相关 issue，先忽略吧。</p><p>使用 <code>podman play</code> 命令可以直接创建完整的 Pod 及其所拥有的容器：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>podman play kube postgresql.yaml
</span></span></code></pre></div><h2 id=总结>总结
<a class=heading-link href=#%e6%80%bb%e7%bb%93><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>如果从 Docker 迁移过来，有以下几点很纠结：</p><ol><li>说好的 rootless，但是如果你想要进行端口映射，那么还是要老老实实 sudo 的</li><li>虽然 systemd 大法好，但是如果 container 直接被删除了，我要单独的管理 systemd service 配置文件（貌似可以通过 OCI hook 实现</li><li>更新真的太快了</li><li>&mldr;</li></ol><p>很多同学都在说 <code>学不动了</code>，纠结归纠结，学还是要学的，说不定最后 <strong>真香</strong> 了呢。</p><p>上述所有功能示例都可以通过官方 Demo 项目运行：https://github.com/containers/Demos/blob/master/podman_cli/README.md。</p><h2 id=参考链接>参考链接
<a class=heading-link href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><ul><li><a href=https://podman.io/blogs/>https://podman.io/blogs/</a></li><li><a href=https://podman.io/blogs/2018/10/03/podman-remove-content-homedir.html>https://podman.io/blogs/2018/10/03/podman-remove-content-homedir.html</a></li><li><a href=https://www.redhat.com/sysadmin/rootless-podman>https://www.redhat.com/sysadmin/rootless-podman</a></li><li><a href=https://mkdev.me/en/posts/dockerless-part-3-moving-development-environment-to-containers-with-podman>https://mkdev.me/en/posts/dockerless-part-3-moving-development-environment-to-containers-with-podman</a></li></ul></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//zdyxry.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2023
Yiran Zhou
·
技术支持 <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0433XDZ3V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G0433XDZ3V",{anonymize_ip:!1})}</script></body></html>