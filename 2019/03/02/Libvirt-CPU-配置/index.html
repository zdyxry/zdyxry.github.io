<!doctype html><html lang=zh-cn><head><title>Libvirt CPU 配置 · Yiran's Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=color-scheme content="light dark"><meta name=author content="Yiran Zhou"><meta name=description content="Libvirt CPU 配置参数 链接到标题 我们先来看下 Libvirt 关于虚拟机 CPU 配置项：
match check mode model &mldr; 具体配置解释可以去 Libvirt 官方文档中查看，这里主要说一下 mode 参数，看一下 mode 具体含义及可选配置：
host-passthrough 链接到标题 Libvirt 通知 KVM 对 CPU 不做任何配置项修改，直通给虚拟机。因为虚拟机可以使用与物理主机相同 CPU 指令集，性能最好，相反，在虚拟机热迁移过程中，对目标主机 CPU 要求同型号同代。
host-model 链接到标题 本质上是根据物理主机 CPU 从 cpu_map.xml 文件中选择最匹配的 CPU 型号。由于CPU定义是在启动虚拟机之前复制的，因此可以在不同主机上使用完全相同的XML，同时仍然提供每个主机支持的最佳虚拟机 CPU。属于在功能与性能之间的平衡。
custom 链接到标题 不指定 mode 属性时的默认值。此模式使得无论虚拟机启动哪个主机，虚拟机都将看到相同的硬件，兼容性最好。
最佳选择 链接到标题 在不考虑虚拟机兼容性（热迁移）情况下，优先选择 host-passthrough ，综合考虑选择 host-model 。
OpenStack 中如果检测到 hypervisor 是 kvm-qemu ，则默认值为 host-model ；在 hypervisor 是其他类型时，默认值为 none，即由 hypervisor 自己选择。
我查看了自己两台 VPS 的 CPU 信息，如下："><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Libvirt CPU 配置"><meta name=twitter:description content="Libvirt CPU 配置参数 链接到标题 我们先来看下 Libvirt 关于虚拟机 CPU 配置项：
match check mode model &mldr; 具体配置解释可以去 Libvirt 官方文档中查看，这里主要说一下 mode 参数，看一下 mode 具体含义及可选配置：
host-passthrough 链接到标题 Libvirt 通知 KVM 对 CPU 不做任何配置项修改，直通给虚拟机。因为虚拟机可以使用与物理主机相同 CPU 指令集，性能最好，相反，在虚拟机热迁移过程中，对目标主机 CPU 要求同型号同代。
host-model 链接到标题 本质上是根据物理主机 CPU 从 cpu_map.xml 文件中选择最匹配的 CPU 型号。由于CPU定义是在启动虚拟机之前复制的，因此可以在不同主机上使用完全相同的XML，同时仍然提供每个主机支持的最佳虚拟机 CPU。属于在功能与性能之间的平衡。
custom 链接到标题 不指定 mode 属性时的默认值。此模式使得无论虚拟机启动哪个主机，虚拟机都将看到相同的硬件，兼容性最好。
最佳选择 链接到标题 在不考虑虚拟机兼容性（热迁移）情况下，优先选择 host-passthrough ，综合考虑选择 host-model 。
OpenStack 中如果检测到 hypervisor 是 kvm-qemu ，则默认值为 host-model ；在 hypervisor 是其他类型时，默认值为 none，即由 hypervisor 自己选择。
我查看了自己两台 VPS 的 CPU 信息，如下："><meta property="og:title" content="Libvirt CPU 配置"><meta property="og:description" content="Libvirt CPU 配置参数 链接到标题 我们先来看下 Libvirt 关于虚拟机 CPU 配置项：
match check mode model &mldr; 具体配置解释可以去 Libvirt 官方文档中查看，这里主要说一下 mode 参数，看一下 mode 具体含义及可选配置：
host-passthrough 链接到标题 Libvirt 通知 KVM 对 CPU 不做任何配置项修改，直通给虚拟机。因为虚拟机可以使用与物理主机相同 CPU 指令集，性能最好，相反，在虚拟机热迁移过程中，对目标主机 CPU 要求同型号同代。
host-model 链接到标题 本质上是根据物理主机 CPU 从 cpu_map.xml 文件中选择最匹配的 CPU 型号。由于CPU定义是在启动虚拟机之前复制的，因此可以在不同主机上使用完全相同的XML，同时仍然提供每个主机支持的最佳虚拟机 CPU。属于在功能与性能之间的平衡。
custom 链接到标题 不指定 mode 属性时的默认值。此模式使得无论虚拟机启动哪个主机，虚拟机都将看到相同的硬件，兼容性最好。
最佳选择 链接到标题 在不考虑虚拟机兼容性（热迁移）情况下，优先选择 host-passthrough ，综合考虑选择 host-model 。
OpenStack 中如果检测到 hypervisor 是 kvm-qemu ，则默认值为 host-model ；在 hypervisor 是其他类型时，默认值为 none，即由 hypervisor 自己选择。
我查看了自己两台 VPS 的 CPU 信息，如下："><meta property="og:type" content="article"><meta property="og:url" content="https://zdyxry.github.io/2019/03/02/Libvirt-CPU-%E9%85%8D%E7%BD%AE/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2019-03-02T19:40:20+00:00"><meta property="article:modified_time" content="2019-03-02T19:40:20+00:00"><link rel=canonical href=https://zdyxry.github.io/2019/03/02/Libvirt-CPU-%E9%85%8D%E7%BD%AE/><link rel=preload href="/fonts/forkawesome-webfont.woff2?v=1.2.0" as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/coder.min.76ce9bad7ac9bd368d486c6e91e7e0906fff71d9d35ccbf93959a375e2bf50e5.css integrity="sha256-ds6brXrJvTaNSGxukefgkG//cdnTXMv5OVmjdeK/UOU=" crossorigin=anonymous media=screen><link rel=stylesheet href=/css/coder-dark.min.593028e7f7ac55c003b79c230d1cd411bb4ca53b31556c3abb7f027170e646e9.css integrity="sha256-WTAo5/esVcADt5wjDRzUEbtMpTsxVWw6u38CcXDmRuk=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=/images/yiran.png sizes=32x32><link rel=icon type=image/png href=/images/yiran.png sizes=16x16><link rel=apple-touch-icon href=/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=/images/apple-touch-icon.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/images/safari-pinned-tab.svg color=#5bbad5><meta name=generator content="Hugo 0.101.0"></head><body class="preload-transitions colorscheme-auto"><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=/>Yiran's Blog</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=/tags/>Tags</a></li><li class=navigation-item><a class=navigation-link href=/friends/>Friends</a></li><li class=navigation-item><a class=navigation-link href=/about/>About</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title><a class=title-link href=https://zdyxry.github.io/2019/03/02/Libvirt-CPU-%E9%85%8D%E7%BD%AE/>Libvirt CPU 配置</a></h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i>
<time datetime=2019-03-02T19:40:20Z>March 2, 2019</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>
阅读时间：2 分钟</span></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i>
<span class=tag><a href=/tags/Libvirt/>Libvirt</a></span></div></div></header><nav id=TableOfContents><ul><li><a href=#libvirt-cpu-配置参数>Libvirt CPU 配置参数</a><ul><li><a href=#host-passthrough>host-passthrough</a></li><li><a href=#host-model>host-model</a></li><li><a href=#custom>custom</a></li></ul></li><li><a href=#最佳选择>最佳选择</a><ul><li><a href=#vultr>Vultr</a></li><li><a href=#bwh>BWH</a></li></ul></li><li><a href=#参考链接>参考链接</a></li></ul></nav><div class=post-content><h2 id=libvirt-cpu-配置参数>Libvirt CPU 配置参数
<a class=heading-link href=#libvirt-cpu-%e9%85%8d%e7%bd%ae%e5%8f%82%e6%95%b0><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>我们先来看下 Libvirt 关于虚拟机 CPU 配置项：</p><ul><li>match</li><li>check</li><li>mode</li><li>model</li><li>&mldr;</li></ul><p>具体配置解释可以去 Libvirt 官方文档中查看，这里主要说一下 <code>mode</code> 参数，看一下 <code>mode</code> 具体含义及可选配置：</p><h3 id=host-passthrough>host-passthrough
<a class=heading-link href=#host-passthrough><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>Libvirt 通知 KVM 对 CPU 不做任何配置项修改，直通给虚拟机。因为虚拟机可以使用与物理主机相同 CPU 指令集，性能最好，相反，在虚拟机热迁移过程中，对目标主机 CPU 要求同型号同代。</p><h3 id=host-model>host-model
<a class=heading-link href=#host-model><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>本质上是根据物理主机 CPU 从 <code>cpu_map.xml</code> 文件中选择最匹配的 CPU 型号。由于CPU定义是在启动虚拟机之前复制的，因此可以在不同主机上使用完全相同的XML，同时仍然提供每个主机支持的最佳虚拟机 CPU。属于在功能与性能之间的平衡。</p><h3 id=custom>custom
<a class=heading-link href=#custom><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><p>不指定 <code>mode</code> 属性时的默认值。此模式使得无论虚拟机启动哪个主机，虚拟机都将看到相同的硬件，兼容性最好。</p><h2 id=最佳选择>最佳选择
<a class=heading-link href=#%e6%9c%80%e4%bd%b3%e9%80%89%e6%8b%a9><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><p>在不考虑虚拟机兼容性（热迁移）情况下，优先选择 <code>host-passthrough</code> ，综合考虑选择 <code>host-model</code> 。</p><p>OpenStack 中如果检测到 hypervisor 是 kvm-qemu ，则默认值为 <code>host-model</code> ；在 hypervisor 是其他类型时，默认值为 <code>none</code>，即由 hypervisor 自己选择。</p><p>我查看了自己两台 VPS 的 CPU 信息，如下：</p><h3 id=vultr>Vultr
<a class=heading-link href=#vultr><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@vultr ~]<span style=font-style:italic># lscpu</span>
</span></span><span style=display:flex><span>Architecture:          x86_64
</span></span><span style=display:flex><span>厂商 ID：           GenuineIntel
</span></span><span style=display:flex><span>CPU 系列：          6
</span></span><span style=display:flex><span>型号：              60
</span></span><span style=display:flex><span>型号名称：        Virtual CPU 71438xxxxxxx
</span></span><span style=display:flex><span>超管理器厂商：  KVM
</span></span><span style=display:flex><span>虚拟化类型：     完全
</span></span><span style=display:flex><span>Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush mmx fxsr sse sse2 syscall nx rdtscp lm constant_tsc rep_good nopl xtopology cpuid tsc_known_freq pni pclmulqdq ssse3 fma cx16 pcid sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand hypervisor lahf_lm abm invpcid_single pti fsgsbase bmi1 avx2 smep bmi2 erms invpcid xsaveopt arat
</span></span></code></pre></div><h3 id=bwh>BWH
<a class=heading-link href=#bwh><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>[root@bwh ~]<span style=font-style:italic># lscpu</span>
</span></span><span style=display:flex><span>Architecture:          x86_64
</span></span><span style=display:flex><span>厂商 ID：           GenuineIntel
</span></span><span style=display:flex><span>CPU 系列：          6
</span></span><span style=display:flex><span>型号：              13
</span></span><span style=display:flex><span>型号名称：        QEMU Virtual CPU version (cpu64-rhel6)
</span></span><span style=display:flex><span>超管理器厂商：  KVM
</span></span><span style=display:flex><span>虚拟化类型：     完全
</span></span><span style=display:flex><span>Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pse36 clflush mmx fxsr sse sse2 ss syscall nx pdpe1gb rdtscp lm rep_good nopl pni pclmulqdq ssse3 cx16 pcid sse4_1 sse4_2 x2apic popcnt aes xsave avx f16c rdrand hypervisor lahf_lm fsgsbase smep xsaveopt
</span></span></code></pre></div><p>可以看到 BWH 的 CPU 比 Vultr CPU 指令集少了很多，而且 CPU 型号是 <code>QEMU Virtual CPU version (cpu64-rhel6)</code> 推断物理机 libvirt 配置是 <code>custom</code> ，果然便宜无好货。</p><h2 id=参考链接>参考链接
<a class=heading-link href=#%e5%8f%82%e8%80%83%e9%93%be%e6%8e%a5><i class="fa fa-link" aria-hidden=true title=链接到标题></i>
<span class=sr-only>链接到标题</span></a></h2><ul><li><a href=https://docs.openstack.org/juno/config-reference/content/kvm.html>https://docs.openstack.org/juno/config-reference/content/kvm.html</a></li><li><a href=https://wiki.openstack.org/wiki/LibvirtXMLCPUModel>https://wiki.openstack.org/wiki/LibvirtXMLCPUModel</a></li><li><a href=https://patchwork.kernel.org/patch/9219601/>https://patchwork.kernel.org/patch/9219601/</a></li><li><a href=https://lists.gnu.org/archive/html/qemu-devel/2016-06/msg00634.html>https://lists.gnu.org/archive/html/qemu-devel/2016-06/msg00634.html</a></li><li><a href=http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html>http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html</a></li></ul></div><footer><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//zdyxry.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}(),document.addEventListener("themeChanged",function(){document.readyState=="complete"&&DISQUS.reset({reload:!0,config:disqus_config})})</script></footer></article></section></div><footer class=footer><section class=container>©
2016 -
2023
Yiran Zhou
·
技术支持 <a href=https://gohugo.io/>Hugo</a> & <a href=https://github.com/luizdepra/hugo-coder/>Coder</a>.</section></footer></main><script src=/js/coder.min.6ae284be93d2d19dad1f02b0039508d9aab3180a12a06dcc71b0b0ef7825a317.js integrity="sha256-auKEvpPS0Z2tHwKwA5UI2aqzGAoSoG3McbCw73gloxc="></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-G0433XDZ3V"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-G0433XDZ3V",{anonymize_ip:!1})}</script></body></html>